<!DOCTYPE html>

<html lang="pt-br">

<head>

ย ย <meta charset="UTF-8">

ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">

ย ย <title>Controle de Clientes</title>

ย ย <style>

ย ย ย ย /* Estilos gerais */

ย ย ย ย body {

ย ย ย ย ย ย font-family: Arial, sans-serif;

ย ย ย ย ย ย padding: 20px;

ย ย ย ย ย ย background-color: #f0f8ff;

ย ย ย ย ย ย color: #333;

ย ย ย ย }

ย ย ย ย .container {

ย ย ย ย ย ย width: 100%;

ย ย ย ย ย ย max-width: 2000px;

ย ย ย ย ย ย margin: auto;

ย ย ย ย ย ย background: #fff;

ย ย ย ย ย ย padding: 20px;

ย ย ย ย ย ย border-radius: 8px;

ย ย ย ย ย ย box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

ย ย ย ย }

ย ย ย ย h1, h3 {

ย ย ย ย ย ย text-align: center;

ย ย ย ย ย ย color: #0066cc;

ย ย ย ย }



ย ย ย ย /* Estilos para Inputs e Botรตes */

ย ย ย ย input[type="text"],

ย ย ย ย input[type="tel"],

ย ย ย ย input[type="date"],

ย ย ย ย textarea {

ย ย ย ย ย ย padding: 10px;

ย ย ย ย ย ย margin-bottom: 10px;

ย ย ย ย ย ย border: 1px solid #ccc;

ย ย ย ย ย ย border-radius: 4px;

ย ย ย ย ย ย box-sizing: border-box;

ย ย ย ย }

ย ย ย ย .input-group-horizontal {

ย ย ย ย ย ย display: flex;

ย ย ย ย ย ย flex-wrap: wrap;

ย ย ย ย ย ย gap: 10px;

ย ย ย ย ย ย margin-bottom: 10px;

ย ย ย ย }

ย ย ย ย .input-group-horizontal input {

ย ย ย ย ย ย flex: 1;

ย ย ย ย ย ย min-width: 150px;

ย ย ย ย ย ย margin-bottom: 0;

ย ย ย ย }

ย ย ย ย .configurable-input {

ย ย ย ย ย ย /* Largura serรก definida pelo JavaScript */

ย ย ย ย }

ย ย ย ย button {

ย ย ย ย ย ย background-color: #0066cc;

ย ย ย ย ย ย color: #fff;

ย ย ย ย ย ย padding: 10px 20px;

ย ย ย ย ย ย margin: 5px 0;

ย ย ย ย ย ย border: none;

ย ย ย ย ย ย border-radius: 4px;

ย ย ย ย ย ย cursor: pointer;

ย ย ย ย ย ย transition: background-color 0.3s;

ย ย ย ย ย ย position: relative; /* Necessรกrio para posicionar o badge */

ย ย ย ย }

ย ย ย ย button:hover {

ย ย ย ย ย ย background-color: #004d99;

ย ย ย ย }



ย ย ย ย /* Estilos especรญficos de botรฃo */

ย ย ย ย .btn-debito-segurar {

ย ย ย ย ย ย background-color: #ffcc00; /* Amarelo fraco */

ย ย ย ย ย ย color: #333; /* Texto escuro para contraste */

ย ย ย ย }

ย ย ย ย .btn-debito-segurar:hover {

ย ย ย ย ย ย background-color: #e6b800; /* Amarelo um pouco mais escuro no hover */

ย ย ย ย }

ย ย ย ย /* Novo estilo para o botรฃo de renovar (Data Atual) */

ย ย ย ย .btn-renovar-data-atual {

ย ย ย ย ย ย background-color: #ffc107; /* Amarelo Bootstrap */

ย ย ย ย ย ย color: #212529; /* Texto escuro */

ย ย ย ย ย ย border: 1px solid #ffc107;

ย ย ย ย }

ย ย ย ย .btn-renovar-data-atual:hover {

ย ย ย ย ย ย background-color: #e0a800;

ย ย ย ย ย ย border-color: #d39e00;

ย ย ย ย }

ย ย ย ย /* Novo estilo para o botรฃo de confirmaรงรฃo perigosa (vermelho) */

ย ย ย ย .modal-confirm-danger {

ย ย ย ย ย ย background-color: #dc3545; /* Vermelho */

ย ย ย ย ย ย color: #fff;

ย ย ย ย }

ย ย ย ย .modal-confirm-danger:hover {

ย ย ย ย ย ย background-color: #c82333; /* Vermelho mais escuro */

ย ย ย ย }



ย ย ย ย /* Estilos da Tabela */

ย ย ย ย table {

ย ย ย ย ย ย width: 100%;

ย ย ย ย ย ย border-collapse: collapse;

ย ย ย ย ย ย margin: 20px 0;

ย ย ย ย ย ย display: none; /* Escondido por padrรฃo, mostrado com JS */

ย ย ย ย }

ย ย ย ย th, td {

ย ย ย ย ย ย padding: 10px;

ย ย ย ย ย ย border: 1px solid #ccc;

ย ย ย ย ย ย text-align: left;

ย ย ย ย }

ย ย ย ย /* Flexbox para td com botรตes */

ย ย ย ย td {

ย ย ย ย ย ย display: flex;

ย ย ย ย ย ย align-items: center;

ย ย ย ย ย ย flex-wrap: nowrap; /* Impede quebras de linha inesperadas nos botรตes */

ย ย ย ย ย ย gap: 5px;

ย ย ย ย }

ย ย ย ย td button {

ย ย ย ย ย ย display: inline-block;

ย ย ย ย ย ย margin-right: 5px;

ย ย ย ย ย ย flex-shrink: 0; /* Previne que os botรตes encolham */

ย ย ย ย }

ย ย ย ยย

ย ย ย ย /* Cores das linhas da tabela - Ajustado para maior especificidade */

ย ย ย ย tr.avisado {

ย ย ย ย ย ย background-color: #007bff !important; /* Azul */

ย ย ย ย ย ย color: white;

ย ย ย ย }

ย ย ย ย tr.debito {

ย ย ย ย ย ย background-color: #ffa500 !important; /* Laranja */

ย ย ย ย }

ย ย ย ย tr.vencendo-hoje {

ย ย ย ย ย ย background-color: #ffff99 !important; /* Amarelo claro */

ย ย ย ย }

ย ย ย ย tr.vencido {

ย ย ย ย ย ย background-color: #ff6666 !important; /* Vermelho claro */

ย ย ย ย }



ย ย ย ย .center {

ย ย ย ย ย ย text-align: center;

ย ย ย ย }



ย ย ย ย /* Estilos de Modal */

ย ย ย ย .modal {

ย ย ย ย ย ย display: none;

ย ย ย ย ย ย position: fixed;

ย ย ย ย ย ย top: 0;

ย ย ย ย ย ย left: 0;

ย ย ย ย ย ย width: 100%;

ย ย ย ย ย ย height: 100%;

ย ย ย ย ย ย background-color: rgba(0, 0, 0, 0.5);

ย ย ย ย ย ย justify-content: center;

ย ย ย ย ย ย align-items: center;

ย ย ย ย ย ย z-index: 1000;

ย ย ย ย }

ย ย ย ย .modal-content {

ย ย ย ย ย ย background-color: #fff;

ย ย ย ย ย ย padding: 20px;

ย ย ย ย ย ย border-radius: 8px;

ย ย ย ย ย ย text-align: center;

ย ย ย ย ย ย width: 90%;

ย ย ย ย ย ย max-width: 400px;

ย ย ย ย ย ย box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);

ย ย ย ย }

ย ย ย ย .modal button {

ย ย ย ย ย ย background-color: #0066cc;

ย ย ย ย ย ย color: #fff;

ย ย ย ย ย ย padding: 10px 20px;

ย ย ย ย ย ย margin: 5px;

ย ย ย ย ย ย border: none;

ย ย ย ย ย ย border-radius: 4px;

ย ย ย ย ย ย cursor: pointer;

ย ย ย ย }

ย ย ย ย .modal button:hover {

ย ย ย ย ย ย background-color: #004d99;

ย ย ย ย }



ย ย ย ย /* รcone de Configuraรงรตes */

ย ย ย ย .settings-icon {

ย ย ย ย ย ย position: fixed;

ย ย ย ย ย ย bottom: 20px;

ย ย ย ย ย ย right: 20px;

ย ย ย ย ย ย font-size: 30px;

ย ย ย ย ย ย cursor: pointer;

ย ย ย ย ย ย background-color: #0066cc;

ย ย ย ย ย ย color: white;

ย ย ย ย ย ย border-radius: 50%;

ย ย ย ย ย ย width: 50px;

ย ย ย ย ย ย height: 50px;

ย ย ย ย ย ย display: flex;

ย ย ย ย ย ย justify-content: center;

ย ย ย ย ย ย align-items: center;

ย ย ย ย ย ย box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);

ย ย ย ย ย ย z-index: 999;

ย ย ย ย ย ย transition: background-color 0.3s;

ย ย ย ย }

ย ย ย ย .settings-icon:hover {

ย ย ย ย ย ย background-color: #004d99;

ย ย ย ย }

ย ย ย ย #settingsArea {

ย ย ย ย ย ย display: none;

ย ย ย ย ย ย background-color: #f9f9f9;

ย ย ย ย ย ย padding: 20px;

ย ย ย ย ย ย border-radius: 8px;

ย ย ย ย ย ย margin-top: 30px;

ย ย ย ย ย ย box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

ย ย ย ย }

ย ย ย ย #settingsArea label {

ย ย ย ย ย ย display: block;

ย ย ย ย ย ย margin-bottom: 5px;

ย ย ย ย ย ย font-weight: bold;

ย ย ย ย }

ย ย ย ย #settingsArea input[type="range"],

ย ย ย ย #settingsArea input[type="number"] {

ย ย ย ย ย ย width: calc(100% - 22px);

ย ย ย ย ย ย margin-bottom: 15px;

ย ย ย ย }



ย ย ย ย /* Estilo para o badge numรฉrico */

ย ย ย ย .notification-badge {

ย ย ย ย ย ย position: absolute;

ย ย ย ย ย ย top: -8px;

ย ย ย ย ย ย right: -8px;

ย ย ย ย ย ย background-color: red;

ย ย ย ย ย ย color: white;

ย ย ย ย ย ย border-radius: 50%;

ย ย ย ย ย ย padding: 3px 7px;

ย ย ย ย ย ย font-size: 0.7em;

ย ย ย ย ย ย min-width: 15px;

ย ย ย ย ย ย text-align: center;

ย ย ย ย ย ย line-height: 1;

ย ย ย ย ย ย box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);

ย ย ย ย }



ย ย ย ย /* Novo estilo para o botรฃo central de mensagens */

ย ย ย ย #centralMessageButton {

ย ย ย ย ย ย display: block;

ย ย ย ย ย ย margin: 20px auto; /* Centraliza o botรฃo */

ย ย ย ย ย ย padding: 15px 30px;

ย ย ย ย ย ย font-size: 1.2em;

ย ย ย ย ย ย background-color: #28a745; /* Verde vibrante */

ย ย ย ย ย ย color: white;

ย ย ย ย ย ย border-radius: 10px;

ย ย ย ย ย ย box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);

ย ย ย ย ย ย transition: background-color 0.3s ease, transform 0.2s ease;

ย ย ย ย }

ย ย ย ย #centralMessageButton:hover {

ย ย ย ย ย ย background-color: #218838;

ย ย ย ย ย ย transform: translateY(-2px);

ย ย ย ย }

ย ย ย ย #centralMessageButton:active {

ย ย ย ย ย ย transform: translateY(0);

ย ย ย ย ย ย box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);

ย ย ย ย }



ย ย ย ย /* Estilos para a nova seรงรฃo de clientes avisados */

ย ย ย ย #clientesAvisadosSection {

ย ย ย ย ย ย margin-top: 30px;

ย ย ย ย ย ย padding-top: 20px;

ย ย ย ย ย ย border-top: 1px solid #eee;

ย ย ย ย }

ย ย ย ย #clientesAvisadosList {

ย ย ย ย ย ย list-style: none;

ย ย ย ย ย ย padding: 0;

ย ย ย ย }

ย ย ย ย #clientesAvisadosList li {

ย ย ย ย ย ย background-color: #e0f2f7; /* Um azul claro para destaque */

ย ย ย ย ย ย border: 1px solid #b3e5fc;

ย ย ย ย ย ย margin-bottom: 8px;

ย ย ย ย ย ย padding: 10px 15px;

ย ย ย ย ย ย border-radius: 5px;

ย ย ย ย ย ย display: flex;

ย ย ย ย ย ย justify-content: space-between;

ย ย ย ย ย ย align-items: center;

ย ย ย ย ย ย flex-wrap: wrap;

ย ย ย ย ย ย gap: 10px;

ย ย ย ย }

ย ย ย ย #clientesAvisadosList li .client-info {

ย ย ย ย ย ย flex-grow: 1;

ย ย ย ย }

ย ย ย ย #clientesAvisadosList li button {

ย ย ย ย ย ย margin-left: 5px;

ย ย ย ย ย ย padding: 8px 12px;

ย ย ย ย ย ย font-size: 0.9em;

ย ย ย ย }

ย ย </style>

</head>

<body>

ย ย <div id="ultimaAtualizacaoInfo"

ย ย ย ย style="position: fixed; top: 10px; right: 10px; font-size: 0.9em; color: #555; background-color: #f9f9f9; padding: 5px 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1001;">

ย ย ย ย รltima Alteraรงรฃo: Nunca

ย ย </div>

ย ย <div class="container">

ย ย ย ย <h1>Controle de Clientes</h1>

ย ย ย ย <button id="centralMessageButton" onclick="enviarProximoClienteVencido()">

ย ย ย ย ย ย Enviar Mensagem para Prรณximo Vencido

ย ย ย ย ย ย <span id="badgeCentralMessage" class="notification-badge" style="display:none;"></span>

ย ย ย ย </button>

ย ย ย ย <button onclick="importarClientes()">Importar Clientes (JSON)</button>

ย ย ย ย <button onclick="exportarClientes()">Exportar Clientes (JSON)</button>



ย ย ย ย <h3>Adicionar Cliente</h3>

ย ย ย ย <div class="input-group-horizontal">

ย ย ย ย ย ย <input type="date" id="dataInput" class="configurable-input" required>

ย ย ย ย ย ย <input type="text" id="nomeInput" class="configurable-input" placeholder="Nome do Cliente" required>

ย ย ย ย ย ย <input type="tel" id="telefoneInput" class="configurable-input" placeholder="Telefone (ex: 11999999999)"

ย ย ย ย ย ย ย ย required>

ย ย ย ย </div>

ย ย ย ย <div>

ย ย ย ย ย ย <label>

ย ย ย ย ย ย ย ย <input type="radio" name="produto" value="UniTv" checked> UniTv

ย ย ย ย ย ย </label>

ย ย ย ย ย ย <label>

ย ย ย ย ย ย ย ย <input type="radio" name="produto" value="Duplecast"> Duplecast

ย ย ย ย ย ย </label>

ย ย ย ย </div>

ย ย ย ย <button onclick="adicionarCliente()">Adicionar Cliente</button>



ย ย ย ย <h3>Filtros e Aรงรตes</h3>

ย ย ย ย <button onclick="filtrarHoje()">Clientes Vencendo Hoje <span id="badgeHoje" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarAmanha()">Clientes Vencendo Amanhรฃ <span id="badgeAmanha" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarVencidos()">Clientes Vencidos <span id="badgeVencidos" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarDebito()">Clientes com Dรฉbito <span id="badgeDebito" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarVerDepois()">Ver Depois <span id="badgeVerDepois" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarArquivados()">Arquivados <span id="badgeArquivados" class="notification-badge"

ย ย ย ย ย ย ย ย style="display:none;"></span></button>

ย ย ย ย <button onclick="filtrarDesativados()">Clientes Desativados <span id="badgeDesativados"

ย ย ย ย ย ย ย ย class="notification-badge" style="display:none;"></span></button>

ย ย ย ย <button onclick="mostrarContagemProdutos()">Produtos</button>

ย ย ย ย <button onclick="exibirTodos()">Reexibir Todos</button>

ย ย ย ย <button onclick="confirmarLimparTodos()">Limpar Todos</button>

ย ย ย ย <button onclick="confirmarDesfazer()">Desfazer รltima Aรงรฃo</button>

ย ย ย ย <button onclick="confirmarRefazer()">Refazer รltima Aรงรฃo</button>



ย ย ย ย <h3>Pesquisa de Clientes</h3>

ย ย ย ย <input type="text" id="searchInput" placeholder="Pesquisar por nome ou telefone" oninput="pesquisarClientes()">

ย ย ย ย <button onclick="limparPesquisa()">Limpar Pesquisa</button>



ย ย ย ย <table>

ย ย ย ย ย ย <thead>

ย ย ย ย ย ย ย ย <tr>

ย ย ย ย ย ย ย ย ย ย <th>Data de Vencimento</th>

ย ย ย ย ย ย ย ย </tr>

ย ย ย ย ย ย </thead>

ย ย ย ย ย ย <tbody id="tabelaClientes"></tbody>

ย ย ย ย </table>

ย ย ย ย <button onclick="compartilharWhatsApp()">Compartilhar no WhatsApp</button>



ย ย ย ย <hr>

ย ย ย ย <div id="clientesAvisadosSection">

ย ย ย ย ย ย <h3>Clientes Avisados (WhatsApp) <span id="badgeOcultos" class="notification-badge"

ย ย ย ย ย ย ย ย ย ย style="display:none;"></span></h3>

ย ย ย ย ย ย <ul id="clientesAvisadosList">

ย ย ย ย ย ย </ul>

ย ย ย ย </div>

ย ย ย ย <hr>

ย ย ย ย <h3>Data Atual</h3>

ย ย ย ย <p id="dataAtual"></p>



ย ย ย ย <div class="settings-icon" onclick="toggleSettingsArea()" title="Ajustes">โ๏ธ</div>

ย ย ย ย <div id="settingsArea">

ย ย ย ย ย ย <h3>Ajustes de Interface</h3>

ย ย ย ย ย ย <p>Defina o tamanho das caixas de entrada de Data, Nome e Telefone.</p>



ย ย ย ย ย ย <div>

ย ย ย ย ย ย ย ย <label for="inputWidth">Largura dos Inputs (em %): <span id="inputWidthValue"></span></label>

ย ย ย ย ย ย ย ย <input type="range" id="inputWidth" min="10" max="100" value="16"

ย ย ย ย ย ย ย ย ย ย oninput="updateInputWidth(this.value)">

ย ย ย ย ย ย </div>

ย ย ย ย ย ย <button onclick="saveSettings()">Salvar Ajustes</button>

ย ย ย ย ย ย <button onclick="resetSettings()">Redefinir Padrรฃo</button>

ย ย ย ย </div>



ย ย ย ย <div id="modalConfirmacao" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Confirmar Duplicaรงรฃo</h3>

ย ย ย ย ย ย ย ย <p>Vocรช tem certeza que deseja duplicar este cliente?</p>

ย ย ย ย ย ย ย ย <button onclick="confirmarDuplicacao()">Confirmar</button>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalExclusao" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Confirmar Exclusรฃo</h3>

ย ย ย ย ย ย ย ย <p>Vocรช tem certeza que deseja excluir este cliente?</p>

ย ย ย ย ย ย ย ย <button onclick="confirmarExclusao()">Confirmar</button>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalRenovarComDebito" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Renovar com Dรฉbito?</h3>

ย ย ย ย ย ย ย ย <p>Tem certeza que deseja renovar este cliente e marcรก-lo como Dรฉbito?</p>

ย ย ย ย ย ย ย ย <button id="btnConfirmarRenovacaoDebito">Confirmar</button>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalConfirmacaoGenerica" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3 id="modalConfirmacaoGenericaTitulo">Confirmaรงรฃo</h3>

ย ย ย ย ย ย ย ย <p id="modalConfirmacaoGenericaMensagem">Tem certeza?</p>

ย ย ย ย ย ย ย ย <button id="btnConfirmacaoGenericaConfirmar">Confirmar</button>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalEdicao" class="modal" style="display: none;"></div>

ย ย ย ย <div id="modalAlerta" class="modal" style="display: none;"></div>



ย ย ย ย <div id="modalContagemProdutos" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Contagem de Produtos</h3>

ย ย ย ย ย ย ย ย <p>UniTv: <span id="countUniTv">0</span> clientes <button

ย ย ย ย ย ย ย ย ย ย ย ย onclick="filtrarPorProduto('UniTv')">Detalhes</button></p>

ย ย ย ย ย ย ย ย <p>Duplecast: <span id="countDuplecast">0</span> clientes <button

ย ย ย ย ย ย ย ย ย ย ย ย onclick="filtrarPorProduto('Duplecast')">Detalhes</button></p>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Fechar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalEscolherProduto" class="modal">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Escolher Tipo de Produto</h3>

ย ย ย ย ย ย ย ย <p>Selecione o tipo de produto para o cliente:</p>

ย ย ย ย ย ย ย ย <button onclick="alterarProdutoClienteConfirm('UniTv')">UniTv</button>

ย ย ย ย ย ย ย ย <button onclick="alterarProdutoClienteConfirm('Duplecast')">Duplecast</button>

ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>



ย ย ย ย <div id="modalConflitoIdNome" class="modal" style="display: none;">

ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย <h3>Conflito de Cliente por ID</h3>

ย ย ย ย ย ย ย ย <p>O cliente importado possui o mesmo ID final de telefone (<span id="conflitoId"></span>) que um

ย ย ย ย ย ย ย ย ย ย cliente existente, mas os nomes sรฃo diferentes.</p>

ย ย ย ย ย ย ย ย <p><b>Cliente Existente:</b> <span id="conflitoNomeExistente"></span></p>

ย ย ย ย ย ย ย ย <p><b>Cliente Importado:</b> <span id="conflitoNomeImportado"></span></p>

ย ย ย ย ย ย ย ย <p>O que deseja fazer?</p>

ย ย ย ย ย ย ย ย <button id="btnConflitoManterExistente">Manter o Existente</button>

ย ย ย ย ย ย ย ย <button id="btnConflitoUsarImportado">Atualizar Cliente Existente</button>

ย ย ย ย ย ย ย ย <button id="btnConflitoManterAmbos">Manter Ambos (Criar Novo Cliente)</button>

ย ย ย ย ย ย ย ย <button onclick="cancelarConflitoIdNome()">Cancelar Importaรงรฃo Deste</button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>

ย ย </div>

ย ย <script>

ย ย ย ย let clientes = []; // Inicializado como array vazio, serรก preenchido por loadClientes()

ย ย ย ย let clientesFiltrados = [];

ย ย ย ย let clienteIndexParaExcluir = null;

ย ย ย ย let clienteIndexParaDuplicar = null;

ย ย ย ย let clienteIndexParaRenovarDebito = null;

ย ย ย ย let clienteIndexParaAlterarProduto = null;

ย ย ย ย let modoExibicaoArquivados = false;

ย ย ย ย let modoExibicaoOcultos = false; // Este agora serรก usado para a seรงรฃo dedicada, nรฃo para o filtro principal.

ย ย ย ย let modoExibicaoVerDepois = false;

ย ย ย ย let modoExibicaoDesativados = false;

ย ย ย ย let filtroProduto = null;

ย ย ย ย let historicoClientes = [];

ย ย ย ย let redoHistory = [];

ย ย ย ย const MAX_HISTORY_STATES = 10;

ย ย ย ย let confirmActionCallback = null;



ย ย ย ย // Variรกveis para gerenciar o processo de importaรงรฃo com conflitos

ย ย ย ย let clientesParaProcessarImportacao = [];

ย ย ย ย let currentIndexImportacao = 0;



ย ย ย ย // Variรกveis para o botรฃo de mensagem central

ย ย ย ย let clientesVencidosParaMensagem = [];

ย ย ย ย let indiceClienteVencidoAtual = 0;



ย ย ย ย // Variรกvel para armazenar o ID do cliente para "Renovar HOJE"

ย ย ย ย let clienteIdParaRenovarHoje = null;



ย ย ย ย // ====================================================================================

ย ย ย ย // NOVO: URL do seu Aplicativo da Web do Google Apps Script

ย ย ย ย // *** IMPORTANTE: ESTE ร O URL QUE VOCร FORNECEU! ***

ย ย ย ย const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyHKKeGamiImtqK0G-DJpJI3E_y83ZlVQq6A3kjW0LmRE9iRvNuG3VCOQmpt_s2XwLIrg/exec';

ย ย ย ย // ====================================================================================



ย ย ย ย // Funรงรฃo auxiliar para enviar requisiรงรตes ao backend (Apps Script)

ย ย ย ย async function sendRequestToBackend(action, data = {}) {

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย const url = `${WEB_APP_URL}?action=${action}`;

ย ย ย ย ย ย ย ย const options = {

ย ย ย ย ย ย ย ย ย ย method: 'POST', // Padrรฃo POST para aรงรตes que modificam dados

ย ย ย ย ย ย ย ย ย ย headers: {

ย ย ย ย ย ย ย ย ย ย ย ย 'Content-Type': 'text/plain;charset=utf-8', // Crucial para o Apps Script interpretar o JSON

ย ย ย ย ย ย ย ย ย ย },

ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(data),

ย ย ย ย ย ย ย ย ย ย muteHttpExceptions: true // Importante para que o fetch nรฃo lance erro em 4xx/5xx e possamos ler a resposta do Apps Script

ย ย ย ย ย ย ย ย };



ย ย ย ย ย ย ย ย if (action === 'get_all_clients') {

ย ย ย ย ย ย ย ย ย ย options.method = 'GET';

ย ย ย ย ย ย ย ย ย ย delete options.body; // Requisiรงรตes GET nรฃo devem ter corpo

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย const response = await fetch(url, options);

ย ย ย ย ย ย ย ย if (!response.ok) {

ย ย ย ย ย ย ย ย ย ย const errorText = await response.text();

ย ย ย ย ย ย ย ย ย ย console.error(`Erro de rede ou servidor (${response.status}):`, errorText);

ย ย ย ย ย ย ย ย ย ย throw new Error(`Erro de rede ou servidor: ${response.status} - ${errorText}`);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const result = await response.json();

ย ย ย ย ย ย ย ย if (result && result.status === 'error') {

ย ย ย ย ย ย ย ย ย ย throw new Error(result.message || 'Erro desconhecido do backend.');

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย return result; // Para getAllClients, isso serรก o array de clientes. Para outras, o objeto de status.

ย ย ย ย ย ย } catch (error) {

ย ย ย ย ย ย ย ย console.error('Erro na comunicaรงรฃo com o backend:', error);

ย ย ย ย ย ย ย ย exibirAlerta(`Erro ao salvar/carregar dados: ${error.message}. Verifique a conexรฃo e o script.`);

ย ย ย ย ย ย ย ย throw error; // Re-lanรงa para que as funรงรตes chamadoras possam lidar

ย ย ย ย ย ย }

ย ย ย ย }



ย ย ย ย // --- Funรงรฃo para atualizar a data e hora da รบltima alteraรงรฃo de dados ---

ย ย ย ย function atualizarUltimaAtualizacao(acao = "dados atualizados", clienteNome = "") {

ย ย ย ย ย ย const now = new Date();

ย ย ย ย ย ย const options = {

ย ย ย ย ย ย ย ย year: 'numeric',

ย ย ย ย ย ย ย ย month: '2-digit',

ย ย ย ย ย ย ย ย day: '2-digit',

ย ย ย ย ย ย ย ย hour: '2-digit',

ย ย ย ย ย ย ย ย minute: '2-digit',

ย ย ย ย ย ย ย ย second: '2-digit',

ย ย ย ย ย ย ย ย hour12: false

ย ย ย ย ย ย };

ย ย ย ย ย ย const formattedDateTime = now.toLocaleString('pt-BR', options);



ย ย ย ย ย ย let fullMessage = `รltima Alteraรงรฃo: ${formattedDateTime}`;

ย ย ย ย ย ย if (clienteNome) {

ย ย ย ย ย ย ย ย // Remove o "(UniTv)" ou "(Duplecast)" do nome para a mensagem

ย ย ย ย ย ย ย ย const nomeLimpoParaMsg = clienteNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย fullMessage += ` - ${nomeLimpoParaMsg} (${acao})`;

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย fullMessage += ` (${acao})`;

ย ย ย ย ย ย }



ย ย ย ย ย ย // Salva a mensagem completa no localStorage

ย ย ย ย ย ย localStorage.setItem('ultimaAtualizacaoCliente', fullMessage);

ย ย ย ย ย ย document.getElementById('ultimaAtualizacaoInfo').textContent = fullMessage;



ย ย ย ย ย ย // Opcional: Loga a mensagem no console para depuraรงรฃo

ย ย ย ย ย ย console.log(fullMessage);

ย ย ย ย }

ย ย ย ย // --- Fim da funรงรฃo de atualizaรงรฃo ---

ย ย ย ย function salvarEstadoNoHistorico(clearRedo = true) {

ย ย ย ย ย ย const estadoAtual = JSON.parse(JSON.stringify(clientes));

ย ย ย ย ย ย historicoClientes.push(estadoAtual);



ย ย ย ย ย ย if (historicoClientes.length > MAX_HISTORY_STATES) {

ย ย ย ย ย ย ย ย historicoClientes.shift();

ย ย ย ย ย ย }



ย ย ย ย ย ย if (clearRedo) {

ย ย ย ย ย ย ย ย redoHistory = [];

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function exibirConfirmacaoGenerica(titulo, mensagem, callback, isDanger = false) {

ย ย ย ย ย ย const modal = document.getElementById("modalConfirmacaoGenerica");

ย ย ย ย ย ย const btnConfirmar = document.getElementById("btnConfirmacaoGenericaConfirmar");



ย ย ย ย ย ย document.getElementById("modalConfirmacaoGenericaTitulo").innerText = titulo;

ย ย ย ย ย ย document.getElementById("modalConfirmacaoGenericaMensagem").innerHTML = mensagem;

ย ย ย ย ย ย confirmActionCallback = callback;



ย ย ย ย ย ย if (isDanger) {

ย ย ย ย ย ย ย ย btnConfirmar.classList.add("modal-confirm-danger");

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย btnConfirmar.classList.remove("modal-confirm-danger");

ย ย ย ย ย ย }



ย ย ย ย ย ย btnConfirmar.onclick = () => {

ย ย ย ย ย ย ย ย if (confirmActionCallback) {

ย ย ย ย ย ย ย ย ย ย confirmActionCallback();

ย ย ย ย ย ย ย ย ย ย confirmActionCallback = null;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย };



ย ย ย ย ย ย modal.style.display = "flex";

ย ย ย ย ย ย document.addEventListener("keydown", fecharComEsc);

ย ย ย ย }

ย ย ย ย function fecharModal() {

ย ย ย ย ย ย document.getElementById("modalConfirmacao").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalExclusao").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalRenovarComDebito").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalConfirmacaoGenerica").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalConflitoIdNome").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalContagemProdutos").style.display = "none";

ย ย ย ย ย ย document.getElementById("modalEscolherProduto").style.display = "none";



ย ย ย ย ย ย const modalEdicao = document.getElementById("modalEdicao");

ย ย ย ย ย ย if (modalEdicao) {

ย ย ย ย ย ย ย ย modalEdicao.style.display = "none";

ย ย ย ย ย ย ย ย modalEdicao.innerHTML = "";

ย ย ย ย ย ย ย ย document.removeEventListener("keydown", fecharComEsc);

ย ย ย ย ย ย }

ย ย ย ย ย ย const modalAlerta = document.getElementById("modalAlerta");

ย ย ย ย ย ย if (modalAlerta) {

ย ย ย ย ย ย ย ย modalAlerta.style.display = "none";

ย ย ย ย ย ย ย ย modalAlerta.innerHTML = "";

ย ย ย ย ย ย ย ย document.removeEventListener("keydown", fecharComEscOuEnter);

ย ย ย ย ย ย }

ย ย ย ย ย ย clienteIdParaRenovarHoje = null; // Resetar apรณs fechar o modal

ย ย ย ย }

ย ย ย ย function fecharComEsc(event) {

ย ย ย ย ย ย if (event.key === "Escape") {

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function fecharComEscOuEnter(event) {

ย ย ย ย ย ย if (event.key === "Enter" || event.key === "Escape") {

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function exibirAlerta(mensagem) {

ย ย ย ย ย ย let modalAlerta = document.getElementById("modalAlerta");

ย ย ย ย ย ย modalAlerta.style.display = "flex";

ย ย ย ย ย ย modalAlerta.innerHTML = `

ย ย ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย ย ย <h3>Aviso</h3>

ย ย ย ย ย ย ย ย ย ย <p>${mensagem}</p>

ย ย ย ย ย ย ย ย ย ย <button onclick="fecharModal()">OK</button>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย `;

ย ย ย ย ย ย document.addEventListener("keydown", fecharComEscOuEnter);

ย ย ย ย }

ย ย ย ย document.addEventListener('keydown', function (event) {

ย ย ย ย ย ย if (event.key === "Enter" && document.getElementById("modalExclusao").style.display === "flex") {

ย ย ย ย ย ย ย ย confirmarExclusao();

ย ย ย ย ย ย }

ย ย ย ย });

ย ย ย ย async function adicionarCliente() {

ย ย ย ย ย ย const dataInput = document.getElementById("dataInput").value.trim();

ย ย ย ย ย ย const nomeInput = document.getElementById("nomeInput").value.trim();

ย ย ย ย ย ย const telefoneInput = document.getElementById("telefoneInput").value.trim();

ย ย ย ย ย ย const produtoSelecionado = document.querySelector('input[name="produto"]:checked').value;



ย ย ย ย ย ย if (!dataInput || !nomeInput || !telefoneInput) {

ย ย ย ย ย ย ย ย return exibirAlerta("Por favor, insira a data, o nome e o telefone do cliente.");

ย ย ย ย ย ย }



ย ย ย ย ย ย const telefoneLimpo = telefoneInput.replace(/[^\d]/g, '');

ย ย ย ย ย ย if (telefoneLimpo.length < 5) {

ย ย ย ย ย ย ย ย return exibirAlerta("O telefone deve ter pelo menos 5 dรญgitos para gerar o ID.");

ย ย ย ย ย ย }

ย ย ย ย ย ย const clienteId = telefoneLimpo.slice(-5); // Pega os รบltimos 5 dรญgitos como ID

ย ย ย ย ย ย // Verifica se jรก existe um cliente com este ID (telefone final)

ย ย ย ย ย ย const clienteExistenteComMesmoId = clientes.find(c => c.id === clienteId);

ย ย ย ย ย ย if (clienteExistenteComMesmoId) {

ย ย ย ย ย ย ย ย // Se encontrar, avisa o usuรกrio e nรฃo adiciona

ย ย ย ย ย ย ย ย return exibirAlerta(`Jรก existe um cliente com o ID final de telefone ${clienteId} (Nome: ${clienteExistenteComMesmoId.nome}). Por favor, use um telefone final diferente ou edite o cliente existente.`);

ย ย ย ย ย ย }



ย ย ย ย ย ย salvarEstadoNoHistorico(); // Salva o estado atual ANTES da modificaรงรฃo



ย ย ย ย ย ย // A data armazenada serรก DD/MM/YYYY

ย ย ย ย ย ย const dataParts = dataInput.split("-"); // Ex: ["2025", "07", "10"]

ย ย ย ย ย ย const dataFormatadaParaArmazenar = `${dataParts[2]}/${dataParts[1]}/${dataParts[0]}`; // DD/MM/YYYY



ย ย ย ย ย ย let nomeComProduto = nomeInput;

ย ย ย ย ย ย if (produtoSelecionado === "UniTv" || produtoSelecionado === "Duplecast") {

ย ย ย ย ย ย ย ย nomeComProduto = `${nomeInput} (${produtoSelecionado})`;

ย ย ย ย ย ย }



ย ย ย ย ย ย clientes.push({

ย ย ย ย ย ย ย ย id: clienteId, // NOVO: Adiciona o ID ao cliente

ย ย ย ย ย ย ย ย data: dataFormatadaParaArmazenar, // Armazena como DD/MM/YYYY

ย ย ย ย ย ย ย ย nome: nomeComProduto,

ย ย ย ย ย ย ย ย telefone: telefoneLimpo,

ย ย ย ย ย ย ย ย avisado: false,

ย ย ย ย ย ย ย ย debito: false,

ย ย ย ย ย ย ย ย Produto: produtoSelecionado,

ย ย ย ย ย ย ย ย arquivado: false,

ย ย ย ย ย ย ย ย oculto: false, // Por padrรฃo, ao adicionar, nรฃo estรก oculto (nรฃo foi avisado)

ย ย ย ย ย ย ย ย verDepois: false,

ย ย ย ย ย ย ย ย desativado: false

ย ย ย ย ย ย });



ย ย ย ย ย ย document.getElementById("nomeInput").value = "";

ย ย ย ย ย ย document.getElementById("telefoneInput").value = "";



ย ย ย ย ย ย await salvarClientes(); // AGORA SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao("adicionado", nomeInput);

ย ย ย ย }

ย ย ย ย async function arquivar(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let clienteParaArquivar = clientesExibidos[index]; // Note: clientesExibidos refere-se ร tabela principal



ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === clienteParaArquivar.id); // Usando ID

ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย clienteOriginal.arquivado = true;

ย ย ย ย ย ย ย ย clienteOriginal.oculto = false; // Quando arquivado, nรฃo estรก mais "oculto por aviso"

ย ย ย ย ย ย ย ย clienteOriginal.verDepois = false;

ย ย ย ย ย ย ย ย clienteOriginal.desativado = false;

ย ย ย ย ย ย }

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false; // Resetar para o comportamento de filtro

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao("arquivado", clienteParaArquivar.nome);

ย ย ย ย }

ย ย ย ย async function desarquivar(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย // Ao desarquivar de uma lista de "arquivados", o index se refere a clientesExibidos

ย ย ย ย ย ย let clienteParaDesarquivar = clientesExibidos[index];



ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === clienteParaDesarquivar.id); // Usando ID

ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย clienteOriginal.arquivado = false;

ย ย ย ย ย ย ย ย // Ao desarquivar, ele pode ou nรฃo ser oculto, dependendo do estado anterior.

ย ย ย ย ย ย ย ย // Nรฃo vamos forรงar 'oculto: false' aqui.

ย ย ย ย ย ย }

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = true; // Manter no modo arquivados para que a tabela seja atualizada corretamente

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao("desarquivado", clienteParaDesarquivar.nome);

ย ย ย ย }

ย ย ย ย function filtrarArquivados() {

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = true;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela(); // Apenas a tabela principal usarรก este filtro

ย ย ย ย ย ย exibirClientesAvisados(); // Certifica-se de que a seรงรฃo avisados nรฃo seja afetada por este filtro

ย ย ย ย }

ย ย ย ย // A funรงรฃo filtrarOcultos nรฃo serรก mais para exibir na tabela principal,

ย ย ย ย // mas sim para um caso onde se queira VER apenas a lista de ocultos (seรงรฃo jรก faz isso)

ย ย ย ย // ou se o filtro for ativado por um botรฃo antigo (melhor remover o botรฃo "Clientes Avisados (WhatsApp)" do "Filtros e Aรงรตes").

ย ย ย ย // Vou manter a funรงรฃo, mas ela nรฃo farรก sentido se a nova seรงรฃo for usada.

ย ย ย ย // Seรงรฃo jรก trata os "avisados/ocultos", entรฃo este botรฃo de filtro pode ser redundante.

ย ย ย ย // Vamos renomear para `mostrarApenasOcultosPorFiltro` para clareza, caso a funcionalidade seja mantida.

ย ย ย ย // No HTML, o botรฃo "Clientes Avisados (WhatsApp)" agora sรณ tem o badge e nรฃo tem mais onclick para filtrar.

ย ย ย ย function mostrarApenasOcultosPorFiltro() { // Renomeada de filtrarOcultos

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = true; // Mantรฉm a flag para exibirTabela

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela(); // Exibe na tabela principal, รบtil para uma "revisรฃo" de avisados.

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a seรงรฃo, que nรฃo muda pelo filtro principal.

ย ย ย ย }

ย ย ย ย function filtrarVerDepois() {

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = true;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo tambรฉm

ย ย ย ย }

ย ย ย ย function filtrarDesativados() {

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = true;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo tambรฉm

ย ย ย ย }

ย ย ย ย function filtrarPorProduto(produto) {

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = produto;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo tambรฉm

ย ย ย ย }

ย ย ย ย let clientesExibidos = [];



ย ย ย ย /**

ย ย ย ย ย* Converte uma data de string "DD/MM/YYYY" para "DD/MM" para exibiรงรฃo.

ย ย ย ย ย* @param {string} dateString - A data no formato "DD/MM/YYYY".

ย ย ย ย ย* @returns {string} A data no formato "DD/MM".

ย ย ย ย ย*/

ย ย ย ย function formatDateForDisplay(dateString) {

ย ย ย ย ย ย if (!dateString) return '';

ย ย ย ย ย ย const parts = dateString.split('/');

ย ย ย ย ย ย if (parts.length === 3) {

ย ย ย ย ย ย ย ย return `${parts[0]}/${parts[1]}`; // Retorna DD/MM

ย ย ย ย ย ย }

ย ย ย ย ย ย // Se o formato nรฃo for DD/MM/YYYY, tenta retornar os primeiros 5 caracteres

ย ย ย ย ย ย // que corresponderiam a DD/MM se a string for parecida com um formato de data.

ย ย ย ย ย ย return dateString.substring(0, 5);ย

ย ย ย ย }



ย ย ย ย function exibirTabela() {

ย ย ย ย ย ย const termoPesquisa = document.getElementById("searchInput").value.trim().toLowerCase();



ย ย ย ย ย ย let clientesParaProcessar;

ย ย ย ย ย ย if (termoPesquisa !== '') {

ย ย ย ย ย ย ย ย // Ao pesquisar, mostre todos os que correspondem, independente do status oculto/arquivado/etc.

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente =>

ย ย ย ย ย ย ย ย ย ย (cliente.nome.toLowerCase().includes(termoPesquisa) || cliente.telefone.includes(termoPesquisa))

ย ย ย ย ย ย ย ย );

ย ย ย ย ย ย ย ย // Reseta todos os modos de exibiรงรฃo quando hรก uma pesquisa ativa.

ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย modoExibicaoOcultos = false; // Importante: a pesquisa pode mostrar ocultos

ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย } else if (modoExibicaoArquivados) {

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente => cliente.arquivado);

ย ย ย ย ย ย } else if (modoExibicaoVerDepois) {

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente => cliente.verDepois && !cliente.arquivado && !cliente.oculto && !cliente.desativado);

ย ย ย ย ย ย } else if (modoExibicaoDesativados) {

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente => cliente.desativado);

ย ย ย ย ย ย } else if (filtroProduto) {

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente => cliente.Produto === filtroProduto && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย } else if (clientesFiltrados.length > 0) {

ย ย ย ย ย ย ย ย // Se houver filtro ativo (hoje, amanhรฃ, vencidos, dรฉbito)

ย ย ย ย ย ย ย ย // Certifique-se de que os clientes avisados nรฃo apareรงam aqui, a menos que o filtro 'ocultos' esteja ativo

ย ย ย ย ย ย ย ย if (modoExibicaoOcultos) { // Se o filtro 'mostrarApenasOcultosPorFiltro' foi clicado

ย ย ย ย ย ย ย ย ย ย clientesParaProcessar = clientesFiltrados; // clientesFiltrados jรก contem os ocultos

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย clientesParaProcessar = clientesFiltrados.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย // Exibiรงรฃo padrรฃo: todos que NรO estรฃo arquivados, ocultos, verDepois ou desativados

ย ย ย ย ย ย ย ย clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย }



ย ย ย ย ย ย clientesExibidos = clientesParaProcessar;

ย ย ย ย ย ย if (clientesExibidos.length === 0) {

ย ย ย ย ย ย ย ย document.querySelector("table").style.display = "none";

ย ย ย ย ย ย ย ย document.getElementById("tabelaClientes").innerHTML = `<tr><td colspan="1" style="text-align: center; color: gray;">Nenhum cliente para exibir neste filtro.</td></tr>`;

ย ย ย ย ย ย ย ย atualizarContadores();

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย document.querySelector("table").style.display = "table";

ย ย ย ย ย ย const tabela = document.getElementById("tabelaClientes");

ย ย ย ย ย ย tabela.innerHTML = "";



ย ย ย ย ย ย clientesExibidos.sort((a, b) => {

ย ย ย ย ย ย ย ย // Converta para objetos Date para uma comparaรงรฃo precisa

ย ย ย ย ย ย ย ย const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataA = new Date(anoA, mesA - 1, diaA);

ย ย ย ย ย ย ย ย const dataB = new Date(anoB, mesB - 1, diaB);

ย ย ย ย ย ย ย ย return dataA - dataB;

ย ย ย ย ย ย });



ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย const hojeFormatadaDDMMYYYY = hoje.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย hoje.getFullYear();



ย ย ย ย ย ย clientesExibidos.forEach((cliente, index) => {

ย ย ย ย ย ย ย ย const tr = document.createElement("tr");



ย ย ย ย ย ย ย ย // Assegure que as classes sejam removidas antes de re-aplicar

ย ย ย ย ย ย ย ย tr.classList.remove("avisado", "debito", "vencendo-hoje", "vencido");



ย ย ย ย ย ย ย ย // As propriedades avisado e debito sรฃo booleanas (true/false)

ย ย ย ย ย ย ย ย if (cliente.avisado) tr.classList.add("avisado");

ย ย ย ย ย ย ย ย if (cliente.debito) tr.classList.add("debito");



ย ย ย ย ย ย ย ย // Lรณgica para vencido e vencendo-hoje

ย ย ย ย ย ย ย ย const [diaCliente, mesCliente, anoCliente] = cliente.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataCliente = new Date(anoCliente, mesCliente - 1, diaCliente); // Data do cliente sem hora

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()); // Hoje sem hora



ย ย ย ย ย ย ย ย if (cliente.data === hojeFormatadaDDMMYYYY) {

ย ย ย ย ย ย ย ย ย ย tr.classList.add("vencendo-hoje");

ย ย ย ย ย ย ย ย } else if (dataCliente < hojeSemHora) { // Comparar datas sem a parte da hora

ย ย ย ย ย ย ย ย ย ย tr.classList.add("vencido");

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย let botoesAcao = '';

ย ย ย ย ย ย ย ย if (modoExibicaoArquivados) {

ย ย ย ย ย ย ย ย ย ย botoesAcao = `

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Desarquivar Cliente" onclick="desarquivar(${index})">Desarquivar</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Excluir Cliente" onclick="excluir(${index})">โ</button>

ย ย ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย } else if (modoExibicaoVerDepois) {

ย ย ย ย ย ย ย ย ย ย botoesAcao = `

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Desmarcar Ver Depois" onclick="toggleVerDepois(${index})">Desmarcar</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Editar Cliente" onclick="editar(${index})">Edit</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Excluir Cliente" onclick="excluir(${index})">โ</button>

ย ย ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย } else if (modoExibicaoDesativados) {

ย ย ย ย ย ย ย ย ย ย botoesAcao = `

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Reativar Cliente" onclick="toggleDesativado(${index})">Reativar</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Excluir Cliente" onclick="excluir(${index})">โ</button>

ย ย ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย } else { // Botรตes para a tabela principal (nรฃo avisados, nรฃo arquivados, etc.)

ย ย ย ย ย ย ย ย ย ย const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย ย ย botoesAcao = `

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Duplicar Cliente" onclick="duplicarCliente(${index})">+</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar Automรกtico" onclick="renovarAutomatico(${index})">๐</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar com Dรฉbito (Confirmaรงรฃo)"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="btn-debito-segurar"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย onclick="pedirConfirmacaoRenovacaoDebito(${index})">DรBITO</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar a Partir de Hoje"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="btn-renovar-data-atual"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย onclick="pedirConfirmacaoRenovarHoje(${index})">RENOVAR HOJE</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Marcar/Desmarcar Ver Depois" onclick="toggleVerDepois(${index})">${cliente.verDepois ? "Desmarcar Ver Depois" : "Ver Depois"}</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Alterar Produto" onclick="abrirModalAlterarProduto(${index})">Produto</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Editar Cliente" onclick="editar(${index})">Edit</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Excluir Cliente" onclick="excluir(${index})">โ</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Arquivar Cliente" onclick="arquivar(${index})">๐</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Desativar Cliente" onclick="toggleDesativado(${index})">Desativar</button>

ย ย ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย tr.innerHTML = `

ย ย ย ย ย ย ย ย ย ย <td>

ย ย ย ย ย ย ย ย ย ย ย ย ${formatDateForDisplay(cliente.data)} <a href="#" onclick="enviarMensagemWhatsApp('${nomeExibicaoBase}', '${cliente.telefone}', ${index}); return false;">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${nomeExibicaoBase} (${cliente.Produto || 'N/I'})

ย ย ย ย ย ย ย ย ย ย ย ย </a>

ย ย ย ย ย ย ย ย ย ย ย ย ${botoesAcao}

ย ย ย ย ย ย ย ย ย ย </td>

ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย tabela.appendChild(tr);

ย ย ย ย ย ย });

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย // --- NOVA FUNรรO: Exibir Clientes Avisados na Seรงรฃo Dedicada ---

ย ย ย ย function exibirClientesAvisados() {

ย ย ย ย ย ย const clientesAvisadosList = document.getElementById('clientesAvisadosList');

ย ย ย ย ย ย clientesAvisadosList.innerHTML = ''; // Limpa a lista existente



ย ย ย ย ย ย const avisados = clientes.filter(cliente => cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado);



ย ย ย ย ย ย if (avisados.length === 0) {

ย ย ย ย ย ย ย ย clientesAvisadosList.innerHTML = '<li>Nenhum cliente avisado para exibir.</li>';

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย avisados.sort((a, b) => {

ย ย ย ย ย ย ย ย const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataA = new Date(anoA, mesA - 1, diaA);

ย ย ย ย ย ย ย ย const dataB = new Date(anoB, mesB - 1, diaB);

ย ย ย ย ย ย ย ย return dataA - dataB;

ย ย ย ย ย ย });



ย ย ย ย ย ย avisados.forEach(cliente => {

ย ย ย ย ย ย ย ย const li = document.createElement('li');

ย ย ย ย ย ย ย ย const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย li.innerHTML = `

ย ย ย ย ย ย ย ย ย ย <div class="client-info">

ย ย ย ย ย ย ย ย ย ย ย ย <strong>${nomeExibicaoBase}</strong> (${cliente.Produto || 'N/I'}) - Vencimento: ${formatDateForDisplay(cliente.data)}

ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="client-actions">

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Reexibir Cliente (Tira do Avisados)" onclick="toggleOcultoFromAvisados('${cliente.id}')">Reexibir</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Duplicar Cliente" onclick="duplicarClienteById('${cliente.id}')">+</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar Automรกtico" onclick="renovarAutomaticoById('${cliente.id}')">๐</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar com Dรฉbito (Confirmaรงรฃo)"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="btn-debito-segurar"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย onclick="pedirConfirmacaoRenovacaoDebitoById('${cliente.id}')">DรBITO</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Renovar a Partir de Hoje"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="btn-renovar-data-atual"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย onclick="pedirConfirmacaoRenovarHojeById('${cliente.id}')">RENOVAR HOJE</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Marcar/Desmarcar Ver Depois" onclick="toggleVerDepoisById('${cliente.id}')">${cliente.verDepois ? "Desmarcar Ver Depois" : "Ver Depois"}</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Alterar Produto" onclick="abrirModalAlterarProdutoById('${cliente.id}')">Produto</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Editar Cliente" onclick="editarClienteById('${cliente.id}')">Edit</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Excluir Cliente" onclick="excluirClienteById('${cliente.id}')">โ</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Arquivar Cliente" onclick="arquivarById('${cliente.id}')">๐</button>

ย ย ย ย ย ย ย ย ย ย ย ย <button title="Desativar Cliente" onclick="toggleDesativadoById('${cliente.id}')">Desativar</button>

ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย clientesAvisadosList.appendChild(li);

ย ย ย ย ย ย });

ย ย ย ย }

ย ย ย ย // Nova funรงรฃo para reexibir/desmarcar oculto diretamente da seรงรฃo de avisados

ย ย ย ย async function toggleOcultoFromAvisados(clientId) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย const clienteOriginalIndex = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].oculto = false; // Desmarca como oculto

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].avisado = false; // Opcional: tambรฉm desmarca como avisado, se desejar

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Remove da lista de avisados

ย ย ย ย ย ย atualizarUltimaAtualizacao("reexibido", clientes[clienteOriginalIndex].nome);

ย ย ย ย }

ย ย ย ย // Funรงรตes auxiliares para uso dos botรตes por ID (na seรงรฃo de avisados)

ย ย ย ย function duplicarClienteById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]]; // Temporariamente define o cliente como o รบnico exibido

ย ย ย ย ย ย ย ย duplicarCliente(0); // Chama a funรงรฃo original com index 0

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos; // Restaura

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function renovarAutomaticoById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย renovarAutomatico(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function pedirConfirmacaoRenovacaoDebitoById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย pedirConfirmacaoRenovacaoDebito(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function pedirConfirmacaoRenovarHojeById(clientId) {

ย ย ย ย ย ย clienteIdParaRenovarHoje = clientId; // Armazena o ID do cliente

ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย "Confirmar Renovaรงรฃo HOJE",

ย ย ย ย ย ย ย ย "Tem certeza que deseja renovar a data de vencimento deste cliente para **HOJE**?",

ย ย ย ย ย ย ย ย confirmarRenovarHoje, // Chama a nova funรงรฃo de confirmaรงรฃo

ย ย ย ย ย ย ย ย false // Nรฃo รฉ uma aรงรฃo perigosa (vermelha)

ย ย ย ย ย ย );

ย ย ย ย }

ย ย ย ย function toggleVerDepoisById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย toggleVerDepois(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function abrirModalAlterarProdutoById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย abrirModalAlterarProduto(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function editarClienteById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย editar(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function excluirClienteById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย excluir(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function arquivarById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos;

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]];

ย ย ย ย ย ย ย ย arquivar(0);

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function toggleDesativadoById(clientId) {

ย ย ย ย ย ย const index = clientes.findIndex(c => c.id === clientId);

ย ย ย ย ย ย if (index !== -1) {

ย ย ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos; // Salva o estado

ย ย ย ย ย ย ย ย clientesExibidos = [clientes[index]]; // Define temporariamente

ย ย ย ย ย ย ย ย toggleDesativado(0); // Chama a funรงรฃo com o รญndice 0 da lista temporรกria

ย ย ย ย ย ย ย ย clientesExibidos = originalClientesExibidos; // Restaura

ย ย ย ย ย ย }

ย ย ย ย }



ย ย ย ย // --- FIM: NOVA FUNรรO ---

ย ย ย ย function pedirConfirmacaoRenovacaoDebito(index) {

ย ย ย ย ย ย clienteIndexParaRenovarDebito = index;

ย ย ย ย ย ย document.getElementById("modalRenovarComDebito").style.display = "flex";

ย ย ย ย ย ย document.getElementById("btnConfirmarRenovacaoDebito").onclick = () => confirmarRenovacaoComDebito();

ย ย ย ย }

ย ย ย ย async function renovarAutomatico(index) {

ย ย ย ย ย ย const cliente = clientesExibidos[index];

ย ย ย ย ย ย const produtoCliente = cliente.Produto || "Nรฃo informado";



ย ย ย ย ย ย if (produtoCliente === "Nรฃo informado") {

ย ย ย ย ย ย ย ย exibirAlerta("O produto do cliente nรฃo estรก informado! Por favor, edite o cliente e defina o produto antes de renovar.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === cliente.id); // Usando ID

ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย if (produtoCliente === "Duplecast") {

ย ย ย ย ย ย ย ย ย ย renovarProximoMes(clienteOriginal);

ย ย ย ย ย ย ย ย } else if (produtoCliente === "UniTv") {

ย ย ย ย ย ย ย ย ย ย renovar30(clienteOriginal);

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย exibirAlerta("Tipo de produto desconhecido para renovaรงรฃo automรกtica.");

ย ย ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย clienteOriginal.debito = false;

ย ย ย ย ย ย ย ย clienteOriginal.oculto = false;

ย ย ย ย ย ย ย ย clienteOriginal.verDepois = false;

ย ย ย ย ย ย ย ย clienteOriginal.desativado = false;

ย ย ย ย ย ย }

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao("renovado automaticamente", cliente.nome);

ย ย ย ย }

ย ย ย ย // --- FUNรรO PARA PEDIR CONFIRMAรรO DO "RENOVAR HOJE" ---

ย ย ย ย function pedirConfirmacaoRenovarHoje(index) {

ย ย ย ย ย ย const cliente = clientesExibidos[index];

ย ย ย ย ย ย clienteIdParaRenovarHoje = cliente.id; // Armazena o ID do cliente clicado

ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย "Confirmar Renovaรงรฃo HOJE",

ย ย ย ย ย ย ย ย `Tem certeza que deseja renovar a data de vencimento de **${cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}** para **HOJE**?`,

ย ย ย ย ย ย ย ย confirmarRenovarHoje, // Chama a nova funรงรฃo de confirmaรงรฃo

ย ย ย ย ย ย ย ย false // Nรฃo รฉ uma aรงรฃo perigosa (vermelha)

ย ย ย ย ย ย );

ย ย ย ย }

ย ย ย ย // --- FUNรรO DE CONFIRMAรรO DO "RENOVAR HOJE" ---

ย ย ย ย async function confirmarRenovarHoje() {

ย ย ย ย ย ย if (clienteIdParaRenovarHoje !== null) {

ย ย ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === clienteIdParaRenovarHoje);



ย ย ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย ย ย ย ย const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย hoje.getFullYear();

ย ย ย ย ย ย ย ย ย ย clienteOriginal.data = hojeFormatada;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.debito = false;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.oculto = false;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.verDepois = false;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.desativado = false;



ย ย ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย ย ย filtroProduto = null;



ย ย ย ย ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย ย ย exibirClientesAvisados();

ย ย ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("renovado a partir da data atual", clienteOriginal.nome);

ย ย ย ย ย ย ย ย ย ย exibirAlerta(`Cliente "${clienteOriginal.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}" renovado para hoje!`);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย clienteIdParaRenovarHoje = null; // Resetar apรณs a aรงรฃo

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย // --- FIM: NOVAS FUNรรES ---



ย ย ย ย async function confirmarRenovacaoComDebito() {

ย ย ย ย ย ย if (clienteIndexParaRenovarDebito !== null) {

ย ย ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย ย ย const cliente = clientesExibidos[clienteIndexParaRenovarDebito];

ย ย ย ย ย ย ย ย const produtoCliente = cliente.Produto || "Nรฃo informado";



ย ย ย ย ย ย ย ย if (produtoCliente === "Nรฃo informado") {

ย ย ย ย ย ย ย ย ย ย exibirAlerta("O produto do cliente nรฃo estรก informado! Por favor, edite o cliente e defina o produto antes de renovar.");

ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === cliente.id); // Usando ID

ย ย ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย ย ย if (produtoCliente === "Duplecast") {

ย ย ย ย ย ย ย ย ย ย ย ย renovarProximoMes(clienteOriginal);

ย ย ย ย ย ย ย ย ย ย } else if (produtoCliente === "UniTv") {

ย ย ย ย ย ย ย ย ย ย ย ย renovar30(clienteOriginal);

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย exibirAlerta("Tipo de produto desconhecido para renovaรงรฃo automรกtica.");

ย ย ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย clienteOriginal.debito = true;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.oculto = false;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.verDepois = false;

ย ย ย ย ย ย ย ย ย ย clienteOriginal.desativado = false;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย clienteIndexParaRenovarDebito = null;

ย ย ย ย ย ย ย ย exibirAlerta("Cliente renovado e marcado como DรBITO!");

ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("renovado com dรฉbito", cliente.nome);

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function renovar30(clienteObj) {

ย ย ย ย ย ย clienteObj.data = incrementarData(clienteObj.data, 30);

ย ย ย ย }

ย ย ย ย function renovarProximoMes(clienteObj) {

ย ย ย ย ย ย const [dia, mes, ano] = clienteObj.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย const dataObj = new Date(ano, mes - 1, dia);



ย ย ย ย ย ย dataObj.setMonth(dataObj.getMonth() + 1);



ย ย ย ย ย ย if (dataObj.getDate() !== dia) {

ย ย ย ย ย ย ย ย dataObj.setDate(0);

ย ย ย ย ย ย }



ย ย ย ย ย ย clienteObj.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;

ย ย ย ย }

ย ย ย ย function incrementarData(data, dias) {

ย ย ย ย ย ย const [dia, mes, ano] = data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย const dataObj = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย dataObj.setDate(dataObj.getDate() + dias);

ย ย ย ย ย ย return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;

ย ย ย ย }

ย ย ย ย function duplicarCliente(index) {

ย ย ย ย ย ย clienteIndexParaDuplicar = index;

ย ย ย ย ย ย document.getElementById("modalConfirmacao").style.display = "flex";

ย ย ย ย }



ย ย ย ย async function confirmarDuplicacao() {

ย ย ย ย ย ย if (clienteIndexParaDuplicar !== null) {

ย ย ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย ย ย const clienteOriginal = clientesExibidos[clienteIndexParaDuplicar];



ย ย ย ย ย ย ย ย // Para duplicar, precisamos gerar um NOVO ID รบnico

ย ย ย ย ย ย ย ย let novoTelefoneBase = clienteOriginal.telefone;

ย ย ย ย ย ย ย ย let novoId = clienteOriginal.id;

ย ย ย ย ย ย ย ย let contadorDuplicacao = 1;

ย ย ย ย ย ย ย ย while (clientes.some(c => c.id === novoId)) {

ย ย ย ย ย ย ย ย ย ย // Tenta criar um ID รบnico adicionando sufixo ao telefone

ย ย ย ย ย ย ย ย ย ย novoTelefoneBase = clienteOriginal.telefone + '_' + contadorDuplicacao;

ย ย ย ย ย ย ย ย ย ย novoId = novoTelefoneBase.slice(-5);

ย ย ย ย ย ย ย ย ย ย if (novoTelefoneBase.length < 5) {

ย ย ย ย ย ย ย ย ย ย ย ย novoId = "DUP" + String(contadorDuplicacao).padStart(3, '0'); // Fallback para ID mais รบnico

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย novoId = novoTelefoneBase.slice(-5);

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย contadorDuplicacao++;

ย ย ย ย ย ย ย ย ย ย if (contadorDuplicacao > 100) {

ย ย ย ย ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo foi possรญvel gerar um ID รบnico para a duplicaรงรฃo. Tente novamente.");

ย ย ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย const novoCliente = {

ย ย ย ย ย ย ย ย ย ย id: novoId,

ย ย ย ย ย ย ย ย ย ย data: clienteOriginal.data,

ย ย ย ย ย ย ย ย ย ย nome: clienteOriginal.nome + " (Cรณpia)",

ย ย ย ย ย ย ย ย ย ย telefone: novoTelefoneBase,

ย ย ย ย ย ย ย ย ย ย avisado: false,

ย ย ย ย ย ย ย ย ย ย debito: false,

ย ย ย ย ย ย ย ย ย ย Produto: clienteOriginal.Produto || "Nรฃo informado",

ย ย ย ย ย ย ย ย ย ย arquivado: false,

ย ย ย ย ย ย ย ย ย ย oculto: false,

ย ย ย ย ย ย ย ย ย ย verDepois: false,

ย ย ย ย ย ย ย ย ย ย desativado: false

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย clientes.push(novoCliente);

ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย clienteIndexParaDuplicar = null;

ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("duplicado", clienteOriginal.nome);

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย async function enviarMensagemWhatsApp(clienteNome, clienteTelefone, index) {

ย ย ย ย ย ย let telefoneParaWhatsApp = clienteTelefone.replace(/\D/g, ''); // Remove todos os nรฃo-dรญgitos

ย ย ย ย ย ย if (!telefoneParaWhatsApp) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรบmero de telefone invรกlido!");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย // Verifica se o nรบmero jรก comeรงa com '55' (cรณdigo do Brasil)

ย ย ย ย ย ย // Se nรฃo comeรงar, adiciona '55' ao inรญcio

ย ย ย ย ย ย if (!telefoneParaWhatsApp.startsWith('55')) {

ย ย ย ย ย ย ย ย telefoneParaWhatsApp = '55' + telefoneParaWhatsApp;

ย ย ย ย ย ย }



ย ย ย ย ย ย const cliente = clientesExibidos[index];

ย ย ย ย ย ย const vencimento = cliente.data; // Data em DD/MM/YYYY

ย ย ย ย ย ย const hoje = new Date();



ย ย ย ย ย ย // Converter a data de vencimento para um objeto Date para comparaรงรฃo

ย ย ย ย ย ย const [diaVenc, mesVenc, anoVenc] = vencimento.split("/").map(num => parseInt(num));

ย ย ย ย ย ย const dataVencimentoObj = new Date(anoVenc, mesVenc - 1, diaVenc);

ย ย ย ย ย ยย

ย ย ย ย ย ย // Zerar as horas para comparaรงรฃo apenas da data

ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

ย ย ย ย ย ย const dataVencimentoSemHora = new Date(dataVencimentoObj.getFullYear(), dataVencimentoObj.getMonth(), dataVencimentoObj.getDate());





ย ย ย ย ย ย const vencido = dataVencimentoSemHora < hojeSemHora;



ย ย ย ย ย ย const hora = hoje.getHours();

ย ย ย ย ย ย let saudacao = "Olรก";

ย ย ย ย ย ย if (hora >= 6 && hora < 12) {

ย ย ย ย ย ย ย ย saudacao = "Bom dia";

ย ย ย ย ย ย } else if (hora >= 12 && hora < 18) {

ย ย ย ย ย ย ย ย saudacao = "Boa tarde";

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย saudacao = "Boa noite";

ย ย ย ย ย ย }



ย ย ย ย ย ย const nomeParaMensagem = clienteNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');



ย ย ย ย ย ย let mensagem;

ย ย ย ย ย ย if (vencido) {

ย ย ย ย ย ย ย ย mensagem = `${saudacao}! Seu plano de TV *estรก vencido* *${vencimento}*. Lembrando que pagando no dia do vencimento o mensal รฉ de 30 reais,apรณs o dia de vencimento o mensal รฉ de 35 reais.O pagamento via PIX pode ser feito no nรบmero: *11950912509* (Waldemar Jose Luiz)`;

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย mensagem = `${saudacao}! Hoje รฉ o vencimento do seu plano de TV.*Vencimento*: ${cliente.data}O pagamento via PIX pode ser realizado no nรบmero: *11950912509* (Waldemar Jose Luiz)`;

ย ย ย ย ย ย }



ย ย ย ย ย ย const url = `https://wa.me/${telefoneParaWhatsApp}?text=${encodeURIComponent(mensagem)}`;

ย ย ย ย ย ย const link = document.createElement("a");

ย ย ย ย ย ย link.href = url;

ย ย ย ย ย ย link.target = "_blank";

ย ย ย ย ย ย link.style.display = 'none';

ย ย ย ย ย ย document.body.appendChild(link);

ย ย ย ย ย ย link.click();



ย ย ย ย ย ย setTimeout(() => {

ย ย ย ย ย ย ย ย if (link.parentNode) {

ย ย ย ย ย ย ย ย ย ย link.parentNode.removeChild(link);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }, 100);



ย ย ย ย ย ย let clienteOriginal = clientes.find(c => c.id === cliente.id);

ย ย ย ย ย ย if (clienteOriginal) {

ย ย ย ย ย ย ย ย clienteOriginal.oculto = true; // Marcar como oculto quando a mensagem รฉ enviada

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo de avisados

ย ย ย ย ย ย atualizarUltimaAtualizacao("mensagem WhatsApp enviada", cliente.nome);

ย ย ย ย }

ย ย ย ย function exportarClientes() {

ย ย ย ย ย ย const clientesParaExportar = clientes.map(c => ({

ย ย ย ย ย ย ย ย id: c.id,

ย ย ย ย ย ย ย ย data: c.data,

ย ย ย ย ย ย ย ย nome: c.nome,

ย ย ย ย ย ย ย ย telefone: c.telefone,

ย ย ย ย ย ย ย ย avisado: c.avisado || false,

ย ย ย ย ย ย ย ย debito: c.debito || false,

ย ย ย ย ย ย ย ย Produto: c.Produto || "Nรฃo informado",

ย ย ย ย ย ย ย ย arquivado: c.arquivado || false,

ย ย ย ย ย ย ย ย oculto: c.oculto || false,

ย ย ย ย ย ย ย ย verDepois: c.verDepois || false,

ย ย ย ย ย ย ย ย desativado: c.desativado || false

ย ย ย ย ย ย }));



ย ย ย ย ย ย const clientesJson = JSON.stringify(clientesParaExportar, null, 4);

ย ย ย ย ย ย const blob = new Blob([clientesJson], { type: "application/json" });

ย ย ย ย ย ย const link = document.createElement("a");

ย ย ย ย ย ย link.href = URL.createObjectURL(blob);

ย ย ย ย ย ย link.download = "clientes.json";

ย ย ย ย ย ย link.click();

ย ย ย ย ย ย atualizarUltimaAtualizacao("clientes exportados");

ย ย ย ย }

ย ย ย ย async function importarClientes(file = null) {

ย ย ย ย ย ย let fileToImport = file;



ย ย ย ย ย ย if (!fileToImport) {

ย ย ย ย ย ย ย ย const input = document.createElement('input');

ย ย ย ย ย ย ย ย input.type = 'file';

ย ย ย ย ย ย ย ย input.accept = '.json';

ย ย ย ย ย ย ย ย input.click(); // Abre o seletor de arquivos



ย ย ย ย ย ย ย ย fileToImport = await new Promise(resolve => {

ย ย ย ย ย ย ย ย ย ย input.onchange = (e) => resolve(e.target.files[0]);

ย ย ย ย ย ย ย ย });



ย ย ย ย ย ย ย ย if (!fileToImport) {

ย ย ย ย ย ย ย ย ย ย return; // Usuรกrio cancelou a seleรงรฃo

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }



ย ย ย ย ย ย const reader = new FileReader();

ย ย ย ย ย ย reader.onload = async () => {

ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย salvarEstadoNoHistorico(); // Salva o estado atual antes de comeรงar a importaรงรฃo



ย ย ย ย ย ย ย ย ย ย const clientesImportadosRaw = JSON.parse(reader.result);

ย ย ย ย ย ย ย ย ย ย clientesParaProcessarImportacao = clientesImportadosRaw.map(c => {

ย ย ย ย ย ย ย ย ย ย ย ย const telefoneLimpo = c.telefone ? String(c.telefone).replace(/[^\d]/g, '') : '';

ย ย ย ย ย ย ย ย ย ย ย ย const id = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;



ย ย ย ย ย ย ย ย ย ย ย ย const nomeAjustado = c.Produto && !c.nome.includes(`(${c.Produto})`) ?

ย ย ย ย ย ย ย ย ย ย ย ย ย ย `${c.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')} (${c.Produto})` :

ย ย ย ย ย ย ย ย ย ย ย ย ย ย c.nome;

ย ย ย ย ย ย ย ย ย ย ย ย return {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย id: id,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย data: c.data,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย nome: nomeAjustado,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย telefone: telefoneLimpo,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย avisado: c.avisado || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย debito: c.debito || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย Produto: c.Produto || "Nรฃo informado",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย arquivado: c.arquivado || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย oculto: c.oculto || false, // Manter o status oculto carregado do localStorage

ย ย ย ย ย ย ย ย ย ย ย ย ย ย verDepois: c.verDepois || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย desativado: c.desativado || false

ย ย ย ย ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย ย ย currentIndexImportacao = 0;

ย ย ย ย ย ย ย ย ย ย let novosClientesAdicionados = 0;

ย ย ย ย ย ย ย ย ย ย let clientesAtualizados = 0;

ย ย ย ย ย ย ย ย ย ย let clientesIgnorados = 0;



ย ย ย ย ย ย ย ย ย ย while (currentIndexImportacao < clientesParaProcessarImportacao.length) {

ย ย ย ย ย ย ย ย ย ย ย ย const clienteImportado = clientesParaProcessarImportacao[currentIndexImportacao];



ย ย ย ย ย ย ย ย ย ย ย ย if (!clienteImportado.id) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย console.warn(`Cliente ignorado na importaรงรฃo por nรฃo ter um ID vรกlido (telefone curto):`, clienteImportado);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientesIgnorados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย currentIndexImportacao++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย continue;

ย ย ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย ย ย ย ย const indexClienteExistente = clientes.findIndex(c => c.id === clienteImportado.id);



ย ย ย ย ย ย ย ย ย ย ย ย if (indexClienteExistente !== -1) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Cliente com o mesmo ID jรก existe

ย ย ย ย ย ย ย ย ย ย ย ย ย ย const clienteExistente = clientes[indexClienteExistente];



ย ย ย ย ย ย ย ย ย ย ย ย ย ย const nomeExistenteBase = clienteExistente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย ย ย ย ย ย ย const nomeImportadoBase = clienteImportado.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');



ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (nomeExistenteBase.toLowerCase() !== nomeImportadoBase.toLowerCase()) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Conflito de nome com mesmo ID, pede decisรฃo ao usuรกrio

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const acao = await perguntarConflitoIdNome(clienteExistente, clienteImportado);



ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (acao === 'usarImportado') {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente] = clienteImportado;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientesAtualizados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else if (acao === 'manterExistente') {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientesIgnorados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else if (acao === 'manterAmbos') { // Handle "Manter Ambos"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย let newId = clienteImportado.id;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย let counter = 1;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย let originalTelefone = clienteImportado.telefone; // Keep original telefone for base

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย while (clientes.some(c => c.id === newId)) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const tempTelefone = originalTelefone + '-' + counter; // Append suffix to phone

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย newId = tempTelefone.slice(-5); // Re-derive ID from suffixed phone

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย counter++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (counter > 1000) { // Safety break

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย console.error("Could not generate a unique ID for 'Manter Ambos' option.");

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย break;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Create a new client object with the original imported data, but a new unique ID and modified phone

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const newClientForBoth = { ...clienteImportado, id: newId, telefone: originalTelefone + '-' + (counter - 1) };

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes.push(newClientForBoth);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย novosClientesAdicionados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Mesmo ID e mesmo nome (base), atualiza a data se a importada for mais recente

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const [diaExistente, mesExistente, anoExistente] = clienteExistente.data.split("/").map(Number);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const dataObjExistente = new Date(anoExistente, mesExistente - 1, diaExistente);



ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const [diaImportado, mesImportado, anoImportado] = clienteImportado.data.split("/").map(Number);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const dataObjImportado = new Date(anoImportado, mesImportado - 1, diaImportado);



ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (dataObjImportado > dataObjExistente) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente] = clienteImportado;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientesAtualizados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Update other fields even if date is not newer, if they are different.

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // This ensures consistency without forcing a date update.

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].nome = clienteImportado.nome;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].telefone = clienteImportado.telefone;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].Produto = clienteImportado.Produto;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].avisado = clienteImportado.avisado;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].debito = clienteImportado.debito;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].arquivado = clienteImportado.arquivado;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].oculto = clienteImportado.oculto;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].verDepois = clienteImportado.verDepois;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes[indexClienteExistente].desativado = clienteImportado.desativado;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientesAtualizados++;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย clientes.push(clienteImportado);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย novosClientesAdicionados++;

ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย currentIndexImportacao++;

ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย ย ย document.getElementById("searchInput").value = "";



ย ย ย ย ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย ย ย ย ย exibirAlerta(`Importaรงรฃo concluรญda: ${novosClientesAdicionados} novos clientes adicionados, ${clientesAtualizados} clientes atualizados, ${clientesIgnorados} ignorados.`);

ย ย ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("clientes importados/atualizados por ID");



ย ย ย ย ย ย ย ย } catch (error) {

ย ย ย ย ย ย ย ย ย ย exibirAlerta("Erro ao importar JSON. Verifique o arquivo ou formato.");

ย ย ย ย ย ย ย ย ย ย console.error("Erro ao importar:", error);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย };

ย ย ย ย ย ย reader.readAsText(fileToImport);

ย ย ย ย }

ย ย ย ย function perguntarConflitoIdNome(clienteExistente, clienteImportado) {

ย ย ย ย ย ย return new Promise((resolve, reject) => {

ย ย ย ย ย ย ย ย document.getElementById('conflitoId').textContent = clienteExistente.id;

ย ย ย ย ย ย ย ย document.getElementById('conflitoNomeExistente').textContent = clienteExistente.nome;

ย ย ย ย ย ย ย ย document.getElementById('conflitoNomeImportado').textContent = clienteImportado.nome;



ย ย ย ย ย ย ย ย document.getElementById('modalConflitoIdNome').style.display = 'flex';



ย ย ย ย ย ย ย ย document.getElementById('btnConflitoManterExistente').onclick = () => {

ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย resolve('manterExistente');

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย document.getElementById('btnConflitoUsarImportado').onclick = () => {

ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย resolve('usarImportado');

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย // New handler for "Manter Ambos"

ย ย ย ย ย ย ย ย document.getElementById('btnConflitoManterAmbos').onclick = () => {

ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย resolve('manterAmbos');

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย window.cancelarConflitoIdNome = () => {

ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย resolve('cancelar');

ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย });

ย ย ย ย }

ย ย ย ย function filtrarHoje() {

ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย hoje.getFullYear();



ย ย ย ย ย ย // Filtra clientes que vencem hoje E nรฃo estรฃo ocultos, arquivados, verDepois ou desativados

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => cliente.data === hojeFormatada && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย function filtrarAmanha() {

ย ย ย ย ย ย const amanha = new Date();

ย ย ย ย ย ย amanha.setDate(amanha.getDate() + 1);

ย ย ย ย ย ย const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย amanha.getFullYear();



ย ย ย ย ย ย // Filtra clientes que vencem amanhรฃ E nรฃo estรฃo ocultos, arquivados, verDepois ou desativados

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => cliente.data === amanhaFormatada && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย function filtrarVencidos() {

ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => {

ย ย ย ย ย ย ย ย const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataCliente = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());



ย ย ย ย ย ย ย ย // Filtra clientes vencidos E nรฃo estรฃo ocultos, arquivados, verDepois ou desativados

ย ย ย ย ย ย ย ย return dataCliente < hojeSemHora && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado;

ย ย ย ย ย ย });

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย function filtrarDebito() {

ย ย ย ย ย ย // CORREรรO: Aplica o filtro de dรฉbito corretamente

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => cliente.debito && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย function exibirTodos() {

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false; // Garante que o modo de filtro de ocultos esteja desativado

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Garante que a seรงรฃo avisados seja atualizada

ย ย ย ย ย ย atualizarContadores();

ย ย ย ย }

ย ย ย ย function confirmarLimparTodos() {

ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย "Limpar Todos os Clientes",

ย ย ย ย ย ย ย ย "Tem certeza que deseja limpar **TODOS** os clientes? Essa aรงรฃo nรฃo pode ser desfeita e os dados serรฃo perdidos permanentemente!",

ย ย ย ย ย ย ย ย limparTodos,

ย ย ย ย ย ย ย ย true

ย ย ย ย ย ย );

ย ย ย ย }

ย ย ย ย function confirmarDesfazer() {

ย ย ย ย ย ย if (historicoClientes.length <= 1) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo hรก aรงรตes para desfazer.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย const estadoPrevistoAposDesfazer = historicoClientes.length > 1 ?

ย ย ย ย ย ย ย ย JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 2])) : [];



ย ย ย ย ย ย if (estadoPrevistoAposDesfazer.length === 0) {

ย ย ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย ย ย "Desfazer รltima Aรงรฃo (CUIDADO!)",

ย ย ย ย ย ย ย ย ย ย "Atenรงรฃo: A prรณxima aรงรฃo de desfazer irรก **LIMPAR TODA A SUA LISTA DE CLIENTES**! Tem certeza que deseja continuar?",

ย ย ย ย ย ย ย ย ย ย desfazer,

ย ย ย ย ย ย ย ย ย ย true

ย ย ย ย ย ย ย ย );

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย ย ย "Desfazer รltima Aรงรฃo",

ย ย ย ย ย ย ย ย ย ย "Tem certeza que deseja desfazer a รบltima alteraรงรฃo? Isso irรก reverter a lista de clientes para o estado anterior.",

ย ย ย ย ย ย ย ย ย ย desfazer,

ย ย ย ย ย ย ย ย ย ย false

ย ย ย ย ย ย ย ย );

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function confirmarRefazer() {

ย ย ย ย ย ย if (redoHistory.length === 0) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo hรก aรงรตes para refazer.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }

ย ย ย ย ย ย exibirConfirmacaoGenerica(

ย ย ย ย ย ย ย ย "Refazer รltima Aรงรฃo",

ย ย ย ย ย ย ย ย "Tem certeza que deseja refazer a รบltima aรงรฃo desfeita?",

ย ย ย ย ย ย ย ย refazer,

ย ย ย ย ย ย ย ย false

ย ย ย ย ย ย );

ย ย ย ย }

ย ย ย ย async function limparTodos() {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย const response = await sendRequestToBackend('clear_all_clients');

ย ย ย ย ย ย ย ย if (response.status === 'success') {

ย ย ย ย ย ย ย ย ย ย clientes = []; // Limpa o array local APรS o sucesso no backend

ย ย ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย ย ย document.getElementById("searchInput").value = "";



ย ย ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย ย ย exibirClientesAvisados();

ย ย ย ย ย ย ย ย ย ย // Nรฃo precisa chamar salvarClientes() aqui, pois o backend jรก limpou

ย ย ย ย ย ย ย ย ย ย exibirAlerta("Todos os clientes foram limpos!");

ย ย ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("lista limpa");

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย exibirAlerta(`Erro ao limpar clientes: ${response.message}`);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error("Erro ao limpar clientes no Google Sheets:", e);

ย ย ย ย ย ย ย ย exibirAlerta("Erro ao limpar clientes no Google Sheets. Verifique a conexรฃo e o script.");

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย async function desfazer() {

ย ย ย ย ย ย if (historicoClientes.length <= 1) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo hรก aรงรตes para desfazer.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย redoHistory.push(JSON.parse(JSON.stringify(clientes)));



ย ย ย ย ย ย historicoClientes.pop();

ย ย ย ย ย ย clientes = JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 1]));



ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTodos(); // Chama exibirTodos para reexibir e atualizar ambas as seรงรตes

ย ย ย ย ย ย exibirAlerta("รltima aรงรฃo desfeita!");

ย ย ย ย ย ย atualizarUltimaAtualizacao("aรงรฃo desfeita");

ย ย ย ย }

ย ย ย ย async function refazer() {

ย ย ย ย ย ย if (redoHistory.length === 0) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo hรก aรงรตes para refazer.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย salvarEstadoNoHistorico(false);

ย ย ย ย ย ย clientes = redoHistory.pop();

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTodos(); // Chama exibirTodos para reexibir e atualizar ambas as seรงรตes

ย ย ย ย ย ย exibirAlerta("รltima aรงรฃo refeita!");

ย ย ย ย ย ย atualizarUltimaAtualizacao("aรงรฃo refeita");

ย ย ย ย }

ย ย ย ย function editar(index) {

ย ย ย ย ย ย let cliente = clientesExibidos[index]; // Note: clientesExibidos pode ser filtrado, entรฃo o index รฉ relativo a ele.

ย ย ย ย ย ย const modalEdicao = document.getElementById("modalEdicao");

ย ย ย ย ย ย modalEdicao.style.display = "flex";



ย ย ย ย ย ย const nomeLimpo = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');



ย ย ย ย ย ย modalEdicao.innerHTML = `

ย ย ย ย ย ย ย ย <div class="modal-content">

ย ย ย ย ย ย ย ย ย ย <h3>Editar Cliente</h3>

ย ย ย ย ย ย ย ย ย ย <input type="text" id="novoNome" value="${nomeLimpo}" placeholder="Nome"><br><br>

ย ย ย ย ย ย ย ย ย ย <input type="tel" id="novoTelefone" value="${cliente.telefone}" placeholder="Telefone"><br><br>

ย ย ย ย ย ย ย ย ย ย <input type="date" id="novaData" value="${formatarParaInputDate(cliente.data)}"><br><br>



ย ย ย ย ย ย ย ย ย ย <div>

ย ย ย ย ย ย ย ย ย ย ย ย <label>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="radio" name="editarProduto" value="UniTv" ${cliente.Produto === "UniTv" ? "checked" : ""}> UniTv

ย ย ย ย ย ย ย ย ย ย ย ย </label>

ย ย ย ย ย ย ย ย ย ย ย ย <label>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="radio" name="editarProduto" value="Duplecast" ${cliente.Produto === "Duplecast" ? "checked" : ""}> Duplecast

ย ย ย ย ย ย ย ย ย ย ย ย </label>

ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <br>

ย ย ย ย ย ย ย ย ย ย <button id="salvarBtn">Salvar</button>

ย ย ย ย ย ย ย ย ย ย <button onclick="fecharModal()">Cancelar</button>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย `;

ย ย ย ย ย ย document.getElementById("novoNome").focus();

ย ย ย ย ย ย // Para salvar a ediรงรฃo, precisamos do index original do cliente na array `clientes`

ย ย ย ย ย ย const originalClienteIndex = clientes.findIndex(c => c.id === cliente.id);

ย ย ย ย ย ย document.getElementById("salvarBtn").onclick = () => salvarEdicao(originalClienteIndex);



ย ย ย ย ย ย document.getElementById("novoNome").addEventListener("keydown", (e) => proximoCampo(e, "novoTelefone"));

ย ย ย ย ย ย document.getElementById("novoTelefone").addEventListener("keydown", (e) => proximoCampo(e, "novaData"));

ย ย ย ย ย ย document.getElementById("novaData").addEventListener("keydown", (e) => {

ย ย ย ย ย ย ย ย if (e.key === "Enter") {

ย ย ย ย ย ย ย ย ย ย e.preventDefault();

ย ย ย ย ย ย ย ย ย ย document.getElementById("salvarBtn").focus();

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย });

ย ย ย ย ย ย document.getElementById("salvarBtn").addEventListener("keydown", (e) => {

ย ย ย ย ย ย ย ย if (e.key === "Enter") {

ย ย ย ย ย ย ย ย ย ย e.preventDefault();

ย ย ย ย ย ย ย ย ย ย salvarEdicao(originalClienteIndex);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย });

ย ย ย ย ย ย document.addEventListener("keydown", fecharComEsc);

ย ย ย ย }

ย ย ย ย function proximoCampo(event, proximoId) {

ย ย ย ย ย ย if (event.key === "Enter") {

ย ย ย ย ย ย ย ย event.preventDefault();

ย ย ย ย ย ย ย ย document.getElementById(proximoId)?.focus();

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย // `index` agora se refere ao index do cliente na array `clientes` original, nรฃo em `clientesExibidos`

ย ย ย ย async function salvarEdicao(originalClienteIndex) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย const clienteParaAtualizar = clientes[originalClienteIndex]; // Use o index direto na array principal



ย ย ย ย ย ย let novoNome = document.getElementById("novoNome").value.trim();

ย ย ย ย ย ย let novoTelefone = document.getElementById("novoTelefone").value.trim();

ย ย ย ย ย ย let novaData = document.getElementById("novaData").value.trim(); // Esta jรก estรก em YYYY-MM-DD

ย ย ย ย ย ย let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value;



ย ย ย ย ย ย if (!novoNome || !novaData) {

ย ย ย ย ย ย ย ย exibirAlerta("Nome e data sรฃo obrigatรณrios!");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย const telefoneLimpoEditado = novoTelefone.replace(/[^\d]/g, ''); // Garante que o telefone esteja limpo

ย ย ย ย ย ย if (telefoneLimpoEditado.length < 5) {

ย ย ย ย ย ย ย ย exibirAlerta("O telefone deve ter pelo menos 5 dรญgitos para gerar o ID.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }

ย ย ย ย ย ย const novoId = telefoneLimpoEditado.slice(-5);



ย ย ย ย ย ย // Verifica se o novo ID jรก existe E nรฃo รฉ o ID do prรณprio cliente que estรก sendo editado

ย ย ย ย ย ย if (novoId !== clienteParaAtualizar.id && clientes.some(c => c.id === novoId && c.id !== clienteParaAtualizar.id)) {

ย ย ย ย ย ย ย ย exibirAlerta(`O novo telefone final (${novoId}) jรก estรก em uso por outro cliente. Por favor, escolha um telefone diferente.`);

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย let nomeSemProduto = novoNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย let nomeComNovoProduto = `${nomeSemProduto} (${novoProduto})`;



ย ย ย ย ย ย clientes[originalClienteIndex].id = novoId; // Atualiza o ID se o telefone mudou

ย ย ย ย ย ย clientes[originalClienteIndex].nome = nomeComNovoProduto;

ย ย ย ย ย ย clientes[originalClienteIndex].telefone = telefoneLimpoEditado; // Salva o telefone limpo

ย ย ย ย ย ย clientes[originalClienteIndex].data = novaData.split("-").reverse().join("/"); // Converte para DD/MM/YYYY para armazenamento

ย ย ย ย ย ย clientes[originalClienteIndex].Produto = novoProduto;



ย ย ย ย ย ย // Resetar modos de exibiรงรฃo e filtros para forรงar uma re-renderizaรงรฃo completa

ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";



ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo de avisados

ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย atualizarUltimaAtualizacao("editado", nomeComNovoProduto);

ย ย ย ย }

ย ย ย ย function formatarParaInputDate(data) {

ย ย ย ย ย ย // Esta funรงรฃo jรก converte DD/MM/YYYY para YYYY-MM-DD

ย ย ย ย ย ย let [dia, mes, ano] = data.split("/");

ย ย ย ย ย ย return `${ano}-${mes}-${dia}`;

ย ย ย ย }

ย ย ย ย function excluir(index) {

ย ย ย ย ย ย const cliente = clientesExibidos[index]; // Cliente da lista atualmente exibida

ย ย ย ย ย ย clienteIndexParaExcluir = clientes.findIndex(c => c.id === cliente.id); // Encontra o index na lista principal

ย ย ย ย ย ย if (clienteIndexParaExcluir !== -1) {

ย ย ย ย ย ย ย ย document.getElementById("modalExclusao").style.display = "flex";

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย async function confirmarExclusao() {

ย ย ย ย ย ย if (clienteIndexParaExcluir !== null) {

ย ย ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย ย ย const clienteParaExcluir = clientes[clienteIndexParaExcluir]; // Pega o cliente do array principal

ย ย ย ย ย ย ย ย const nomeClienteExcluido = clienteParaExcluir.nome;



ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย // Remove do array local primeiro

ย ย ย ย ย ย ย ย ย ย clientes.splice(clienteIndexParaExcluir, 1);

ย ย ย ย ย ย ย ย ย ย // Em seguida, sincroniza o array atualizado com o Sheets

ย ย ย ย ย ย ย ย ย ย const response = await sendRequestToBackend('bulk_update_clients', { clients: clientes });



ย ย ย ย ย ย ย ย ย ย if (response.status === 'success') {

ย ย ย ย ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById("searchInput").value = "";



ย ย ย ย ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย ย ย ย ย exibirClientesAvisados();

ย ย ย ย ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย ย ย ย ย clienteIndexParaExcluir = null;

ย ย ย ย ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao("excluรญdo", nomeClienteExcluido);

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย // Se a exclusรฃo no backend falhar, vocรช pode querer reverter a exclusรฃo localmente

ย ย ย ย ย ย ย ย ย ย ย ย // Ou, mais robusto, re-carregar os clientes do backend para garantir a consistรชncia

ย ย ย ย ย ย ย ย ย ย ย ย clientes.splice(clienteIndexParaExcluir, 0, clienteParaExcluir); // Reinsere se falhar

ย ย ย ย ย ย ย ย ย ย ย ย exibirAlerta(`Falha ao excluir cliente: ${response.message}`);

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย ย ย clientes.splice(clienteIndexParaExcluir, 0, clienteParaExcluir); // Reinsere se falhar

ย ย ย ย ย ย ย ย ย ย console.error("Erro ao excluir cliente no Google Sheets:", e);

ย ย ย ย ย ย ย ย ย ย exibirAlerta("Erro ao excluir cliente no Google Sheets. Verifique a conexรฃo e o script.");

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย async function toggleAvisado(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let cliente = clientesExibidos[index]; // Da tabela principal

ย ย ย ย ย ย let clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);

ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].avisado = !clientes[clienteOriginalIndex].avisado;

ย ย ย ย ย ย ย ย // Se marcar como avisado, tambรฉm o torna oculto da tabela principal

ย ย ย ย ย ย ย ย if (clientes[clienteOriginalIndex].avisado) {

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].oculto = true;

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].oculto = false;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela(); // Atualiza a tabela principal

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao(`status avisado alterado para ${clientes[clienteOriginalIndex].avisado ? 'sim' : 'nรฃo'}`, cliente.nome);

ย ย ย ย }

ย ย ย ย async function toggleDebito(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let cliente = clientesExibidos[index];

ย ย ย ย ย ย let clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);

ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].debito = !clientes[originalClienteIndex].debito;

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarContadores(); // Atualiza os contadores, o badge de dรฉbito serรก atualizado

ย ย ย ย ย ย atualizarUltimaAtualizacao(`status dรฉbito alterado para ${clientes[originalClienteIndex].debito ? 'sim' : 'nรฃo'}`, cliente.nome);

ย ย ย ย }

ย ย ย ย async function toggleVerDepois(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let cliente = clientesExibidos[index];

ย ย ย ย ย ย let clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);

ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].verDepois = !clientes[clienteOriginalIndex].verDepois;

ย ย ย ย ย ย ย ย if (clientes[clienteOriginalIndex].verDepois) {

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].oculto = false; // "Ver Depois" nรฃo รฉ "Oculto por aviso"

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].arquivado = false;

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].desativado = false;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao(`status "Ver Depois" alterado para ${clientes[originalClienteIndex].verDepois ? 'sim' : 'nรฃo'}`, cliente.nome);

ย ย ย ย }

ย ย ย ย async function toggleDesativado(index) {

ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย let cliente = clientesExibidos[index];

ย ย ย ย ย ย let clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);

ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].desativado = !clientes[clienteOriginalIndex].desativado;

ย ย ย ย ย ย ย ย if (clientes[originalClienteIndex].desativado) {

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].avisado = false;

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].debito = false;

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].oculto = false; // Desativado nรฃo รฉ "Oculto por aviso"

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].verDepois = false;

ย ย ย ย ย ย ย ย ย ย clientes[clienteOriginalIndex].arquivado = false;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย atualizarUltimaAtualizacao(`status desativado alterado para ${clientes[originalClienteIndex].desativado ? 'sim' : 'nรฃo'}`, cliente.nome);

ย ย ย ย }

ย ย ย ย function abrirModalAlterarProduto(index) {

ย ย ย ย ย ย clienteIndexParaAlterarProduto = index;

ย ย ย ย ย ย document.getElementById('modalEscolherProduto').style.display = 'flex';

ย ย ย ย }

ย ย ย ย async function alterarProdutoClienteConfirm(novoProduto) {

ย ย ย ย ย ย if (clienteIndexParaAlterarProduto !== null) {

ย ย ย ย ย ย ย ย salvarEstadoNoHistorico();

ย ย ย ย ย ย ย ย const clienteParaAtualizar = clientesExibidos[clienteIndexParaAlterarProduto];

ย ย ย ย ย ย ย ย let clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaAtualizar.id);



ย ย ย ย ย ย ย ย if (clienteOriginalIndex !== -1) {

ย ย ย ย ย ย ย ย ย ย let nomeSemProduto = clientes[clienteOriginalIndex].nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

ย ย ย ย ย ย ย ย ย ย clientes[originalClienteIndex].Produto = novoProduto;

ย ย ย ย ย ย ย ย ย ย clientes[originalClienteIndex].nome = `${nomeSemProduto} (${novoProduto})`;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย clientesFiltrados = [];

ย ย ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย ย ย await salvarClientes(); // SALVA NO GOOGLE SHEETS

ย ย ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย ย ย exibirClientesAvisados(); // Atualiza a nova seรงรฃo

ย ย ย ย ย ย ย ย fecharModal();

ย ย ย ย ย ย ย ย clienteIndexParaAlterarProduto = null;

ย ย ย ย ย ย ย ย exibirAlerta(`Produto do cliente alterado para ${novoProduto}!`);

ย ย ย ย ย ย ย ย atualizarUltimaAtualizacao(`produto alterado para ${novoProduto}`, clienteParaAtualizar.nome);

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย // FUNรรO ORIGINAL: function salvarClientes() { localStorage.setItem('clientes', JSON.stringify(clientes)); }

ย ย ย ย async function salvarClientes() {

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย // O histรณrico `redoHistory` e `historicoClientes` ainda usam o array local.

ย ย ย ย ย ย ย ย // A lรณgica do Apps Script jรก lida com adicionar/atualizar/deletar.

ย ย ย ย ย ย ย ย const response = await sendRequestToBackend('bulk_update_clients', { clients: clientes });

ย ย ย ย ย ย ย ย if (response.status === 'success') {

ย ย ย ย ย ย ย ย ย ย console.log('Dados sincronizados com o Google Sheets com sucesso!');

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย exibirAlerta(`Falha ao sincronizar clientes: ${response.message}`);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error("Erro ao salvar clientes no Google Sheets:", e);

ย ย ย ย ย ย ย ย exibirAlerta("Erro ao salvar clientes no Google Sheets. Verifique a conexรฃo e o script.");

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย // FUNรรO ORIGINAL: function loadClientes() { ... }

ย ย ย ย async function loadClientes() {

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย const response = await sendRequestToBackend('get_all_clients');

ย ย ย ย ย ย ย ย // O Apps Script retorna diretamente o array de clientes em caso de sucesso no getAllClients

ย ย ย ย ย ย ย ย if (Array.isArray(response)) {

ย ย ย ย ย ย ย ย ย ย clientes = response.map(c => {

ย ย ย ย ย ย ย ย ย ย ย ย const telefoneLimpo = String(c.telefone || '').replace(/[^\d]/g, '');

ย ย ย ย ย ย ย ย ย ย ย ย const clienteId = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;



ย ย ย ย ย ย ย ย ย ย ย ย // Se o backend estiver enviando a data no formato ISO (ex: "2025-07-16T03:00:00.000Z"),

ย ย ย ย ย ย ย ย ย ย ย ย // ou YYYY-MM-DD, vamos parseรก-la para DD/MM/YYYY para o objeto cliente local.

ย ย ย ย ย ย ย ย ย ย ย ย let dataClienteFormatada = c.data;

ย ย ย ย ย ย ย ย ย ย ย ย if (c.data && typeof c.data === 'string') {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย let datePart = c.data;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (c.data.includes('T')) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย datePart = c.data.split('T')[0]; // Pega apenas a parte da data "YYYY-MM-DD"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Agora, converte de YYYY-MM-DD para DD/MM/YYYY

ย ย ย ย ย ย ย ย ย ย ย ย ย ย const parts = datePart.split('-');

ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (parts.length === 3) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย dataClienteFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;

ย ย ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย ย ย ย ย // Ao carregar, o status 'oculto' pode vir do Google Sheet agora

ย ย ย ย ย ย ย ย ย ย ย ย // Se vocรช deseja que 'oculto' seja sempre 'false' apรณs um refresh, mantenha a linha abaixo.

ย ย ย ย ย ย ย ย ย ย ย ย // Caso contrรกrio, use c.oculto para manter o estado persistente.

ย ย ย ย ย ย ย ย ย ย ย ย // Decida qual comportamento vocรช prefere. Mantenho 'false' como no seu original.

ย ย ย ย ย ย ย ย ย ย ย ย const isOcultoAposRefresh = false;



ย ย ย ย ย ย ย ย ย ย ย ย return {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย id: c.id || clienteId,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย data: dataClienteFormatada, // Armazena como DD/MM/YYYY

ย ย ย ย ย ย ย ย ย ย ย ย ย ย nome: c.nome,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย telefone: telefoneLimpo,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย avisado: c.avisado || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย debito: c.debito || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย Produto: c.Produto || "Nรฃo informado",

ย ย ย ย ย ย ย ย ย ย ย ย ย ย arquivado: c.arquivado || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย oculto: isOcultoAposRefresh,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย verDepois: c.verDepois || false,

ย ย ย ย ย ย ย ย ย ย ย ย ย ย desativado: c.desativado || false

ย ย ย ย ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย ย ย }).filter(c => c.id !== null); // Filtra clientes sem ID vรกlido

ย ย ย ย ย ย ย ย ย ย console.log("Clientes carregados do Google Sheets:", clientes);

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย console.error("Formato de resposta invรกlido ao carregar clientes:", response);

ย ย ย ย ย ย ย ย ย ย clientes = [];

ย ย ย ย ย ย ย ย ย ย exibirAlerta("Erro: Formato de dados invรกlido recebido do Google Sheets.");

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error("Erro ao carregar clientes do Google Sheets:", e);

ย ย ย ย ย ย ย ย clientes = []; // Garante que a lista esteja vazia em caso de falha grave

ย ย ย ย ย ย ย ย exibirAlerta("Erro ao carregar clientes do Google Sheets. Verifique a conexรฃo e o Apps Script.");

ย ย ย ย ย ย }



ย ย ย ย ย ย // A lรณgica de `ultimaAtualizacaoInfo` ainda pode vir do localStorage

ย ย ย ย ย ย const ultimaAtualizacaoSalva = localStorage.getItem('ultimaAtualizacaoCliente');

ย ย ย ย ย ย if (ultimaAtualizacaoSalva) {

ย ย ย ย ย ย ย ย document.getElementById('ultimaAtualizacaoInfo').textContent = ultimaAtualizacaoSalva;

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย document.getElementById('ultimaAtualizacaoInfo').textContent = `รltima Alteraรงรฃo: Nunca`;

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function compartilharWhatsApp() {

ย ย ย ย ย ย const url = `https://wa.me/?text=${encodeURIComponent('Olรก, estou compartilhando esta lista de clientes com vocรช.')}`;

ย ย ย ย ย ย window.open(url, '_blank');

ย ย ย ย }

ย ย ย ย function pesquisarClientes() {

ย ย ย ย ย ย // A pesquisa agora รฉ tratada diretamente na exibirTabela com base no input

ย ย ย ย ย ย // Nรฃo precisamos de lรณgica de filtro separada aqui, apenas forรงar a atualizaรงรฃo da tabela

ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados(); // Garante que a seรงรฃo avisados tambรฉm se atualize se for o caso

ย ย ย ย }

ย ย ย ย function limparPesquisa() {

ย ย ย ย ย ย document.getElementById("searchInput").value = "";

ย ย ย ย ย ย exibirTodos(); // Chama exibirTodos para reexibir tudo e atualizar ambas as seรงรตes

ย ย ย ย }

ย ย ย ย // --- FUNรรES DE AJUSTES ---

ย ย ย ย const SETTINGS_KEY = 'inputSettings';

ย ย ย ย const DEFAULT_INPUT_WIDTH_PERCENT = 16;

ย ย ย ย function toggleSettingsArea() {

ย ย ย ย ย ย const settingsArea = document.getElementById('settingsArea');

ย ย ย ย ย ย if (settingsArea.style.display === 'block') {

ย ย ย ย ย ย ย ย settingsArea.style.display = 'none';

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย settingsArea.style.display = 'block';

ย ย ย ย ย ย ย ย loadSettings();

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย function applyInputWidth(widthPercent) {

ย ย ย ย ย ย const inputs = document.querySelectorAll('.configurable-input');

ย ย ย ย ย ย inputs.forEach(input => {

ย ย ย ย ย ย ย ย input.style.flexBasis = `${widthPercent}%`;

ย ย ย ย ย ย ย ย input.style.maxWidth = `${widthPercent}%`;

ย ย ย ย ย ย ย ย input.style.width = 'auto';

ย ย ย ย ย ย });

ย ย ย ย }

ย ย ย ย function updateInputWidth(value) {

ย ย ย ย ย ย const widthValueSpan = document.getElementById('inputWidthValue');

ย ย ย ย ย ย widthValueSpan.textContent = `${value}%`;

ย ย ย ย ย ย applyInputWidth(value);

ย ย ย ย }

ย ย ย ย function saveSettings() {

ย ย ย ย ย ย const inputWidth = document.getElementById('inputWidth').value;

ย ย ย ย ย ย localStorage.setItem(SETTINGS_KEY, JSON.stringify({

ย ย ย ย ย ย ย ย width: inputWidth

ย ย ย ย ย ย }));

ย ย ย ย ย ย exibirAlerta("Ajustes salvos com sucesso!");

ย ย ย ย ย ย toggleSettingsArea();

ย ย ย ย }

ย ย ย ย function loadSettings() {

ย ย ย ย ย ย const savedSettings = localStorage.getItem(SETTINGS_KEY);

ย ย ย ย ย ย let widthToApply = DEFAULT_INPUT_WIDTH_PERCENT;



ย ย ย ย ย ย if (savedSettings) {

ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย const settings = JSON.parse(savedSettings);

ย ย ย ย ย ย ย ย ย ย widthToApply = settings.width || DEFAULT_INPUT_WIDTH_PERCENT;

ย ย ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย ย ย console.error("Erro ao carregar ajustes do localStorage:", e);

ย ย ย ย ย ย ย ย ย ย localStorage.removeItem(SETTINGS_KEY);

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }



ย ย ย ย ย ย const inputWidthElement = document.getElementById('inputWidth');

ย ย ย ย ย ย if (inputWidthElement) {

ย ย ย ย ย ย ย ย inputWidthElement.value = widthToApply;

ย ย ย ย ย ย }

ย ย ย ย ย ย const inputWidthValueSpan = document.getElementById('inputWidthValue');

ย ย ย ย ย ย if (inputWidthValueSpan) {

ย ย ย ย ย ย ย ย inputWidthValueSpan.textContent = `${widthToApply}%`;

ย ย ย ย ย ย }

ย ย ย ย ย ย applyInputWidth(widthToApply);

ย ย ย ย }

ย ย ย ย function resetSettings() {

ย ย ย ย ย ย localStorage.removeItem(SETTINGS_KEY);

ย ย ย ย ย ย exibirAlerta("Ajustes redefinidos para o padrรฃo!");

ย ย ย ย ย ย loadSettings();

ย ย ย ย ย ย toggleSettingsArea();

ย ย ย ย }

ย ย ย ย // --- FIM: FUNรรES DE AJUSTES ---

ย ย ย ย // --- Funรงรตes de Contadores ---

ย ย ย ย function atualizarContadores() {

ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย hoje.getFullYear();



ย ย ย ย ย ย // Clientes que sรฃo exibidos na tabela principal (NรO OCULTOS, ARQUIVADOS, VERDEPOIS, DESATIVADOS)

ย ย ย ย ย ย const clientesNaTabelaPrincipal = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);



ย ย ย ย ย ย const countHoje = clientesNaTabelaPrincipal.filter(cliente => cliente.data === hojeFormatada).length;

ย ย ย ย ย ย const countAmanha = clientesNaTabelaPrincipal.filter(cliente => {

ย ย ย ย ย ย ย ย const amanha = new Date();

ย ย ย ย ย ย ย ย amanha.setDate(amanha.getDate() + 1);

ย ย ย ย ย ย ย ย const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย amanha.getFullYear();

ย ย ย ย ย ย ย ย return cliente.data === amanhaFormatada;

ย ย ย ย ย ย }).length;

ย ย ย ย ย ย const countVencidos = clientesNaTabelaPrincipal.filter(cliente => {

ย ย ย ย ย ย ย ย const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataCliente = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());



ย ย ย ย ย ย ย ย return dataCliente < hojeSemHora;

ย ย ย ย ย ย }).length;

ย ย ย ย ย ย const countDebito = clientesNaTabelaPrincipal.filter(cliente => cliente.debito).length;



ย ย ย ย ย ย // O contador de ocultos agora conta para o badge na nova seรงรฃo.

ย ย ย ย ย ย const countOcultos = clientes.filter(cliente => cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado).length;

ย ย ย ย ย ย const countArquivados = clientes.filter(cliente => cliente.arquivado).length;

ย ย ย ย ย ย const countVerDepois = clientes.filter(cliente => cliente.verDepois).length;

ย ย ย ย ย ย const countDesativados = clientes.filter(cliente => cliente.desativado).length;



ย ย ย ย ย ย updateBadge('badgeHoje', countHoje);

ย ย ย ย ย ย updateBadge('badgeAmanha', countAmanha);

ย ย ย ย ย ย updateBadge('badgeVencidos', countVencidos);

ย ย ย ย ย ย updateBadge('badgeDebito', countDebito);

ย ย ย ย ย ย updateBadge('badgeOcultos', countOcultos); // Badge da nova seรงรฃo

ย ย ย ย ย ย updateBadge('badgeArquivados', countArquivados);

ย ย ย ย ย ย updateBadge('badgeVerDepois', countVerDepois);

ย ย ย ย ย ย updateBadge('badgeDesativados', countDesativados);



ย ย ย ย ย ย // Atualiza o contador do botรฃo central de mensagens

ย ย ย ย ย ย const vencidosNaoOcultosParaMensagem = clientes.filter(cliente => {

ย ย ย ย ย ย ย ย const [dia, mes, ano] = cliente.data.split("/").map(Number);

ย ย ย ย ย ย ย ย const dataCliente = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

ย ย ย ย ย ย ย ย const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" + (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" + hoje.getFullYear();



ย ย ย ย ย ย ย ย // Considera apenas vencidos OU vencendo hoje, e que NรO estรฃo ocultos, arquivados, verDepois ou desativados

ย ย ย ย ย ย ย ย const isVencendoHoje = cliente.data === hojeFormatada;

ย ย ย ย ย ย ย ย const isVencido = dataCliente < hojeSemHora;



ย ย ย ย ย ย ย ย return (isVencendoHoje || isVencido) && !cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado;

ย ย ย ย ย ย });

ย ย ย ย ย ย updateBadge('badgeCentralMessage', vencidosNaoOcultosParaMensagem.length);

ย ย ย ย }

ย ย ย ย function updateBadge(badgeId, count) {

ย ย ย ย ย ย const badge = document.getElementById(badgeId);

ย ย ย ย ย ย if (badge) {

ย ย ย ย ย ย ย ย if (count > 0) {

ย ย ย ย ย ย ย ย ย ย badge.textContent = count;

ย ย ย ย ย ย ย ย ย ย badge.style.display = 'inline-block';

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย badge.style.display = 'none';

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย }

ย ย ย ย // --- FIM: Funรงรตes de Contadores ---



ย ย ย ย function mostrarContagemProdutos() {

ย ย ย ย ย ย const clientesNaoArquivadosNaoOcultos = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

ย ย ย ย ย ย const countUniTv = clientesNaoArquivadosNaoOcultos.filter(cliente => cliente.Produto === 'UniTv').length;

ย ย ย ย ย ย const countDuplecast = clientesNaoArquivadosNaoOcultos.filter(cliente => cliente.Produto === 'Duplecast').length;



ย ย ย ย ย ย document.getElementById('countUniTv').textContent = countUniTv;

ย ย ย ย ย ย document.getElementById('countDuplecast').textContent = countDuplecast;



ย ย ย ย ย ย document.getElementById('modalContagemProdutos').style.display = 'flex';

ย ย ย ย }

ย ย ย ย // --- Lรณgica para o botรฃo central de mensagens ---

ย ย ย ย function prepararClientesVencidosParaMensagem() {

ย ย ย ย ย ย const hoje = new Date();

ย ย ย ย ย ย const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย hoje.getFullYear();



ย ย ย ย ย ย clientesVencidosParaMensagem = clientes.filter(cliente => {

ย ย ย ย ย ย ย ย const [dia, mes, ano] = cliente.data.split("/").map(Number);

ย ย ย ย ย ย ย ย const dataCliente = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());



ย ย ย ย ย ย ย ย // Considera apenas vencidos OU vencendo hoje, e que NรO estรฃo ocultos, arquivados, verDepois ou desativados

ย ย ย ย ย ย ย ย const isVencendoHoje = cliente.data === hojeFormatada;

ย ย ย ย ย ย ย ย const isVencido = dataCliente < hojeSemHora;



ย ย ย ย ย ย ย ย return (isVencendoHoje || isVencido) && !cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado;

ย ย ย ย ย ย }).sort((a, b) => {

ย ย ย ย ย ย ย ย // Opcional: Ordena por data de vencimento (os mais antigos primeiro)

ย ย ย ย ย ย ย ย const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataA = new Date(anoA, mesA - 1, diaA);

ย ย ย ย ย ย ย ย const dataB = new Date(anoB, mesB - 1, diaB);

ย ย ย ย ย ย ย ย return dataA - dataB;

ย ย ย ย ย ย });

ย ย ย ย ย ย indiceClienteVencidoAtual = 0;

ย ย ย ย ย ย atualizarContadores(); // Atualiza o badge do botรฃo central

ย ย ย ย }

ย ย ย ย function enviarProximoClienteVencido() {

ย ย ย ย ย ย // Se a lista de clientes vencidos ainda nรฃo foi preparada ou estรก vazia, prepara

ย ย ย ย ย ย if (clientesVencidosParaMensagem.length === 0 || indiceClienteVencidoAtual >= clientesVencidosParaMensagem.length) {

ย ย ย ย ย ย ย ย prepararClientesVencidosParaMensagem();

ย ย ย ย ย ย }



ย ย ย ย ย ย if (clientesVencidosParaMensagem.length === 0) {

ย ย ย ย ย ย ย ย exibirAlerta("Nรฃo hรก clientes vencidos para enviar mensagem no momento.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย const cliente = clientesVencidosParaMensagem[indiceClienteVencidoAtual];

ย ย ย ย ย ย const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');



ย ย ย ย ย ย // Envia a mensagem (reutilizando a funรงรฃo existente)

ย ย ย ย ย ย // Para garantir que enviarMensagemWhatsApp funcione com o cliente correto,

ย ย ย ย ย ย // vamos adaptar a chamada para passar o objeto cliente diretamente.

ย ย ย ย ย ย // A funรงรฃo `enviarMensagemWhatsApp` original espera um `index` que aponta para `clientesExibidos`.

ย ย ย ย ย ย // Para evitar modificar `clientesExibidos` globalmente, vamos simular isso para a chamada.

ย ย ย ย ย ย const originalClientesExibidos = clientesExibidos; // Salva o estado atual de clientesExibidos

ย ย ย ย ย ย clientesExibidos = [cliente]; // Temporariamente, clientesExibidos tem apenas o cliente atual

ย ย ย ย ย ย enviarMensagemWhatsApp(nomeExibicaoBase, cliente.telefone, 0); // Chama com index 0 porque `cliente` รฉ o รบnico elemento



ย ย ย ย ย ย clientesExibidos = originalClientesExibidos; // Restaura clientesExibidos



ย ย ย ย ย ย // Move para o prรณximo cliente

ย ย ย ย ย ย indiceClienteVencidoAtual++;

ย ย ย ย ย ย if (indiceClienteVencidoAtual >= clientesVencidosParaMensagem.length) {

ย ย ย ย ย ย ย ย exibirAlerta("Todas as mensagens para clientes vencidos foram enviadas (ou a lista foi percorrida). Clique novamente para recarregar a lista.");

ย ย ย ย ย ย ย ย prepararClientesVencidosParaMensagem(); // Prepara a lista novamente caso queira circular

ย ย ย ย ย ย }

ย ย ย ย ย ย atualizarContadores(); // Atualiza o badge apรณs o envio

ย ย ย ย }

ย ย ย ย // --- FIM: Lรณgica para o botรฃo central de mensagens ---

ย ย ย ย async function inicializarExibicaoClientes() {

ย ย ย ย ย ย await loadClientes(); // Await para garantir que os clientes sejam carregados antes de qualquer outra operaรงรฃo



ย ย ย ย ย ย const today = new Date();

ย ย ย ย ย ย const year = today.getFullYear();

ย ย ย ย ย ย const month = String(today.getMonth() + 1).padStart(2, '0');

ย ย ย ย ย ย const day = String(today.getDate()).padStart(2, '0');

ย ย ย ย ย ย document.getElementById('dataInput').value = `${year}-${month}-${day}`;



ย ย ย ย ย ย const hojeFormatada = today.getDate().toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย (today.getMonth() + 1).toString().padStart(2, '0') + "/" +

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย today.getFullYear();



ย ย ย ย ย ย // Filtra clientes para a exibiรงรฃo inicial: vencendo hoje OU vencidos,

ย ย ย ย ย ย // E que NรO estรฃo arquivados, ocultos, verDepois ou desativados.

ย ย ย ย ย ย clientesFiltrados = clientes.filter(cliente => {

ย ย ย ย ย ย ย ย const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));

ย ย ย ย ย ย ย ย const dataCliente = new Date(ano, mes - 1, dia);

ย ย ย ย ย ย ย ย const hojeSemHora = new Date(today.getFullYear(), today.getMonth(), today.getDate());



ย ย ย ย ย ย ย ย const isVencendoHoje = cliente.data === hojeFormatada;

ย ย ย ย ย ย ย ย const isVencido = dataCliente < hojeSemHora;



ย ย ย ย ย ย ย ย return (isVencendoHoje || isVencido) && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado;

ย ย ย ย ย ย });



ย ย ย ย ย ย modoExibicaoArquivados = false;

ย ย ย ย ย ย modoExibicaoOcultos = false;

ย ย ย ย ย ย modoExibicaoVerDepois = false;

ย ย ย ย ย ย modoExibicaoDesativados = false;

ย ย ย ย ย ย filtroProduto = null;

ย ย ย ย ย ย document.getElementById("searchInput").value = "";



ย ย ย ย ย ย exibirTabela();

ย ย ย ย ย ย exibirClientesAvisados();

ย ย ย ย ย ย prepararClientesVencidosParaMensagem();

ย ย ย ย ย ย salvarEstadoNoHistorico(); // Garante o primeiro estado para o histรณrico de "desfazer"

ย ย ย ย ย ย loadSettings();

ย ย ย ย }

ย ย ย ย // Inicializaรงรฃo

ย ย ย ย document.addEventListener('DOMContentLoaded', () => {

ย ย ย ย ย ย // A data atual sempre serรก exibida no formato dd/mm/yyyy aqui, pois รฉ um parรกgrafo simples.

ย ย ย ย ย ย // Se quiser dd/mm aqui tambรฉm, altere a linha abaixo.

ย ย ย ย ย ย document.getElementById('dataAtual').innerText = new Date().toLocaleDateString('pt-BR');

ย ย ย ย ย ย inicializarExibicaoClientes();

ย ย ย ย });

ย ย </script>

</body>

</html>
