
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <style>
        td {
            white-space: nowrap;
        }

        td button {
            display: inline-block;
            margin-right: 5px;
        }

        td {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 5px;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f8ff;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 2000px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1,
        h3 {
            text-align: center;
            color: #0066cc;
        }

        input[type="text"],
        input[type="tel"],
        input[type="date"],
        textarea {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .input-group-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group-horizontal input {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }

        .configurable-input {
            /* Largura ser√° definida pelo JavaScript, agora com 16% como padr√£o */
        }

        button {
            background-color: #0066cc;
            color: #fff;
            padding: 10px 20px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
            /* Necess√°rio para posicionar o badge */
        }

        button:hover {
            background-color: #004d99;
        }

        /* Estilo para o novo bot√£o de d√©bito */
        .btn-debito-segurar {
            background-color: #ffcc00;
            /* Amarelo fraco */
            color: #333;
            /* Texto escuro para contraste */
        }

        .btn-debito-segurar:hover {
            background-color: #e6b800;
            /* Amarelo um pouco mais escuro no hover */
        }

        /* Novo estilo para o bot√£o de confirma√ß√£o perigosa (vermelho) */
        .modal-confirm-danger {
            background-color: #dc3545;
            /* Vermelho */
            color: #fff;
        }

        .modal-confirm-danger:hover {
            background-color: #c82333;
            /* Vermelho mais escuro */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            display: none;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .avisado {
            background-color: #007bff !important;
        }

        .debito {
            background-color: #ffa500 !important;
        }

        .vencendo-hoje {
            background-color: #ffff99 !important;
        }

        .vencido {
            background-color: #ff6666 !important;
        }

        .center {
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal button {
            background-color: #0066cc;
            color: #fff;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: #004d99;
        }

        .settings-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            background-color: #0066cc;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 999;
            transition: background-color 0.3s;
        }

        .settings-icon:hover {
            background-color: #004d99;
        }

        #settingsArea {
            display: none;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #settingsArea label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #settingsArea input[type="range"],
        #settingsArea input[type="number"] {
            width: calc(100% - 22px);
            margin-bottom: 15px;
        }

        /* Estilo para o badge num√©rico */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7em;
            min-width: 15px;
            text-align: center;
            line-height: 1;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Clientes</h1>
        <button onclick="importarClientes()">Importar Clientes (JSON)</button>
        <button onclick="exportarClientes()">Exportar Clientes (JSON)</button>

        <h3>Adicionar Cliente</h3>
        <div class="input-group-horizontal">
            <input type="date" id="dataInput" class="configurable-input" required>
            <input type="text" id="nomeInput" class="configurable-input" placeholder="Nome do Cliente" required>
            <input type="tel" id="telefoneInput" class="configurable-input" placeholder="Telefone (ex: 11999999999)"
                required>
        </div>
        <div>
            <label>
                <input type="radio" name="produto" value="UniTv" checked> UniTv
            </label>
            <label>
                <input type="radio" name="produto" value="Duplecast"> Duplecast
            </label>
        </div>
        <button onclick="adicionarCliente()">Adicionar Cliente</button>

        <h3>Filtros e A√ß√µes</h3>
        <button onclick="filtrarHoje()">Clientes Vencendo Hoje <span id="badgeHoje" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarAmanha()">Clientes Vencendo Amanh√£ <span id="badgeAmanha" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarVencidos()">Clientes Vencidos <span id="badgeVencidos" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarDebito()">Clientes com D√©bito <span id="badgeDebito" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarOcultos()">Clientes Avisados (WhatsApp) <span id="badgeOcultos"
                class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarVerDepois()">Ver Depois <span id="badgeVerDepois" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarArquivados()">Arquivados <span id="badgeArquivados" class="notification-badge"
                style="display:none;"></span></button>
        <button onclick="filtrarDesativados()">Clientes Desativados <span id="badgeDesativados"
                class="notification-badge" style="display:none;"></span></button>
        <button onclick="mostrarContagemProdutos()">Produtos</button>
        <button onclick="exibirTodos()">Reexibir Todos</button>
        <button onclick="confirmarLimparTodos()">Limpar Todos</button>
        <button onclick="confirmarDesfazer()">Desfazer √öltima A√ß√£o</button>
        <button onclick="confirmarRefazer()">Refazer √öltima A√ß√£o</button>

        <h3>Pesquisa de Clientes</h3>
        <input type="text" id="searchInput" placeholder="Pesquisar por nome ou telefone" oninput="pesquisarClientes()">
        <button onclick="limparPesquisa()">Limpar Pesquisa</button>

        <table>
            <thead>
                <tr>
                    <th>Data de Vencimento</th>
                </tr>
            </thead>
            <tbody id="tabelaClientes"></tbody>
        </table>
        <button onclick="compartilharWhatsApp()">Compartilhar no WhatsApp</button>
        <h3>Data Atual</h3>
        <p id="dataAtual"></p>

        <div class="settings-icon" onclick="toggleSettingsArea()" title="Ajustes">‚öôÔ∏è</div>
        <div id="settingsArea">
            <h3>Ajustes de Interface</h3>
            <p>Defina o tamanho das caixas de entrada de Data, Nome e Telefone.</p>

            <div>
                <label for="inputWidth">Largura dos Inputs (em %): <span id="inputWidthValue"></span></label>
                <input type="range" id="inputWidth" min="10" max="100" value="16"
                    oninput="updateInputWidth(this.value)">
            </div>
            <button onclick="saveSettings()">Salvar Ajustes</button>
            <button onclick="resetSettings()">Redefinir Padr√£o</button>
        </div>

        <div id="modalConfirmacao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Duplica√ß√£o</h3>
                <p>Voc√™ tem certeza que deseja duplicar este cliente?</p>
                <button onclick="confirmarDuplicacao()">Confirmar</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
        <div id="modalExclusao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Exclus√£o</h3>
                <p>Voc√™ tem certeza que deseja excluir este cliente?</p>
                <button onclick="confirmarExclusao()">Confirmar</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
        <div id="modalRenovarComDebito" class="modal">
            <div class="modal-content">
                <h3>Renovar com D√©bito?</h3>
                <p>Tem certeza que deseja renovar este cliente e marc√°-lo como D√©bito?</p>
                <button id="btnConfirmarRenovacaoDebito">Confirmar</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
        <div id="modalConfirmacaoGenerica" class="modal">
            <div class="modal-content">
                <h3 id="modalConfirmacaoGenericaTitulo">Confirma√ß√£o</h3>
                <p id="modalConfirmacaoGenericaMensagem">Tem certeza?</p>
                <button id="btnConfirmacaoGenericaConfirmar">Confirmar</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
        <div id="modalEdicao" class="modal" style="display: none;"></div>
        <div id="modalAlerta" class="modal" style="display: none;"></div>

        <div id="modalContagemProdutos" class="modal">
            <div class="modal-content">
                <h3>Contagem de Produtos</h3>
                <p>UniTv: <span id="countUniTv">0</span> clientes <button
                        onclick="filtrarPorProduto('UniTv')">Detalhes</button></p>
                <p>Duplecast: <span id="countDuplecast">0</span> clientes <button
                        onclick="filtrarPorProduto('Duplecast')">Detalhes</button></p>
                <button onclick="fecharModal()">Fechar</button>
            </div>
        </div>

        <div id="modalEscolherProduto" class="modal">
            <div class="modal-content">
                <h3>Escolher Tipo de Produto</h3>
                <p>Selecione o tipo de produto para o cliente:</p>
                <button onclick="alterarProdutoClienteConfirm('UniTv')">UniTv</button>
                <button onclick="alterarProdutoClienteConfirm('Duplecast')">Duplecast</button>
                <button onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        document.body.innerHTML = document.body.innerHTML.replace(/\s+/g, " ").trim();
        let clientes = []; // Inicializado como array vazio, ser√° preenchido por loadClientes()
        let clientesFiltrados = [];
        let clienteIndexParaExcluir = null;
        let clienteIndexParaDuplicar = null;
        let clienteIndexParaRenovarDebito = null;
        let clienteIndexParaAlterarProduto = null; // NOVO: Para alterar produto
        let modoExibicaoArquivados = false;
        let modoExibicaoOcultos = false;
        let modoExibicaoVerDepois = false;
        let modoExibicaoDesativados = false;
        let filtroProduto = null; // NOVO: Vari√°vel para controlar o filtro por produto
        let historicoClientes = [];
        let redoHistory = [];
        const MAX_HISTORY_STATES = 10;
        let confirmActionCallback = null;

        // --- Fun√ß√£o para atualizar a data e hora da √∫ltima atualiza√ß√£o ---
        function atualizarUltimaAtualizacao(acao = "dados atualizados") {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const formattedDateTime = now.toLocaleString('pt-BR', options);
            // Comentado pois o segundo c√≥digo n√£o tem o elemento 'ultimaAtualizacaoInfo'
            // document.getElementById('ultimaAtualizacaoInfo').textContent = `√öltima Atualiza√ß√£o: ${formattedDateTime} (${acao})`;
        }

        // --- Fim da fun√ß√£o de atualiza√ß√£o ---

        function salvarEstadoNoHistorico(clearRedo = true) {
            const estadoAtual = JSON.parse(JSON.stringify(clientes));
            historicoClientes.push(estadoAtual);

            if (historicoClientes.length > MAX_HISTORY_STATES) {
                historicoClientes.shift();
            }

            if (clearRedo) {
                redoHistory = [];
            }
        }

        function exibirConfirmacaoGenerica(titulo, mensagem, callback, isDanger = false) {
            const modal = document.getElementById("modalConfirmacaoGenerica");
            const btnConfirmar = document.getElementById("btnConfirmacaoGenericaConfirmar");

            document.getElementById("modalConfirmacaoGenericaTitulo").innerText = titulo;
            document.getElementById("modalConfirmacaoGenericaMensagem").innerHTML = mensagem;
            confirmActionCallback = callback;

            if (isDanger) {
                btnConfirmar.classList.add("modal-confirm-danger");
            } else {
                btnConfirmar.classList.remove("modal-confirm-danger");
            }

            btnConfirmar.onclick = () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                    confirmActionCallback = null;
                }
                fecharModal();
            };

            modal.style.display = "flex";
            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharModal() {
            document.getElementById("modalConfirmacao").style.display = "none";
            document.getElementById("modalExclusao").style.display = "none";
            document.getElementById("modalRenovarComDebito").style.display = "none";
            document.getElementById("modalConfirmacaoGenerica").style.display = "none";
            // NOVO: Adiciona os modals de produto
            document.getElementById("modalContagemProdutos").style.display = "none";
            document.getElementById("modalEscolherProduto").style.display = "none";

            const modalEdicao = document.getElementById("modalEdicao");
            if (modalEdicao) {
                modalEdicao.style.display = "none";
                modalEdicao.innerHTML = "";
                document.removeEventListener("keydown", fecharComEsc);
            }
            const modalAlerta = document.getElementById("modalAlerta");
            if (modalAlerta) {
                modalAlerta.style.display = "none";
                modalAlerta.innerHTML = "";
                document.removeEventListener("keydown", fecharComEscOuEnter);
            }
        }

        function fecharComEsc(event) {
            if (event.key === "Escape") {
                fecharModal();
            }
        }

        function fecharComEscOuEnter(event) {
            if (event.key === "Enter" || event.key === "Escape") {
                fecharModal();
            }
        }

        function exibirAlerta(mensagem) {
            let modalAlerta = document.getElementById("modalAlerta");
            modalAlerta.style.display = "flex";
            modalAlerta.innerHTML = `
                <div class="modal-content">
                    <h3>Aviso</h3>
                    <p>${mensagem}</p>
                    <button onclick="fecharModal()">OK</button>
                </div>
            `;
            document.addEventListener("keydown", fecharComEscOuEnter);
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === "Enter" && document.getElementById("modalExclusao").style.display === "flex") {
                confirmarExclusao();
            }
        });

        function adicionarCliente() {
            const dataInput = document.getElementById("dataInput").value.trim();
            const nomeInput = document.getElementById("nomeInput").value.trim();
            const telefoneInput = document.getElementById("telefoneInput").value.trim();
            const produtoSelecionado = document.querySelector('input[name="produto"]:checked').value; // NOVO: Captura o produto
            if (!dataInput || !nomeInput || !telefoneInput) {
                return exibirAlerta("Por favor, insira a data, o nome e o telefone do cliente.");
            }

            salvarEstadoNoHistorico();
            const dataParts = dataInput.split("-");
            const dataFormatada = `${dataParts[2]}/${dataParts[1]}/${dataParts[0]}`;
            const telefoneLimpo = telefoneInput.replace(/[^\d]/g, '');

            // NOVO: Adiciona o produto ao nome e ao objeto cliente
            let nomeComProduto = nomeInput;
            if (produtoSelecionado === "UniTv" || produtoSelecionado === "Duplecast") {
                nomeComProduto = `${nomeInput} (${produtoSelecionado})`;
            }

            clientes.push({
                data: dataFormatada,
                nome: nomeComProduto, // Nome j√° com o produto
                telefone: telefoneLimpo,
                avisado: false,
                debito: false,
                Produto: produtoSelecionado, // NOVO: Armazena o produto separadamente
                arquivado: false,
                oculto: false,
                verDepois: false,
                desativado: false
            });

            // Limpa os campos ap√≥s adicionar, mas mant√©m a data preenchida para o pr√≥ximo
            // document.getElementById("dataInput").value = ""; // Removido para manter a data preenchida
            document.getElementById("nomeInput").value = "";
            document.getElementById("telefoneInput").value = "";

            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("cliente adicionado");
        }

        function arquivar(index) {
            salvarEstadoNoHistorico();
            let clienteParaArquivar = clientesExibidos[index];

            let clienteOriginal = clientes.find(c => c.nome === clienteParaArquivar.nome && c.data === clienteParaArquivar.data && c.telefone === clienteParaArquivar.telefone);
            if (clienteOriginal) {
                clienteOriginal.arquivado = true;
                clienteOriginal.oculto = false;
                clienteOriginal.verDepois = false;
                clienteOriginal.desativado = false;
            }
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("cliente arquivado");
        }

        function desarquivar(index) {
            salvarEstadoNoHistorico();
            let clienteParaDesarquivar = clientesExibidos[index];

            let clienteOriginal = clientes.find(c => c.nome === clienteParaDesarquivar.nome && c.data === clienteParaDesarquivar.data && c.telefone === clienteParaDesarquivar.telefone);
            if (clienteOriginal) {
                clienteOriginal.arquivado = false;
            }
            clientesFiltrados = [];
            modoExibicaoArquivados = true;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("cliente desarquivado");
        }

        function filtrarArquivados() {
            clientesFiltrados = [];
            modoExibicaoArquivados = true;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarUltimaAtualizacao("filtrado por arquivados");
        }

        function filtrarOcultos() {
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = true;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarUltimaAtualizacao("filtrado por avisados");
        }

        function filtrarVerDepois() {
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = true;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarUltimaAtualizacao("filtrado por ver depois");
        }

        function filtrarDesativados() {
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = true;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarUltimaAtualizacao("filtrado por desativados");
        }

        // NOVO: Fun√ß√£o para filtrar por produto (vinda do primeiro c√≥digo)
        function filtrarPorProduto(produto) {
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = produto;
            document.getElementById("searchInput").value = "";
            fecharModal();
            exibirTabela();
            atualizarUltimaAtualizacao(`filtrado por produto: ${produto}`);
        }

        let clientesExibidos = [];
        function exibirTabela() {
            const termoPesquisa = document.getElementById("searchInput").value.trim().toLowerCase();

            let clientesParaProcessar;

            if (termoPesquisa !== '') {
                // Se h√° pesquisa, ignora todos os outros filtros e busca em todos os clientes
                clientesParaProcessar = clientes.filter(cliente =>
                    (cliente.nome.toLowerCase().includes(termoPesquisa) || cliente.telefone.includes(termoPesquisa))
                );
                // Limpa os modos de exibi√ß√£o para a pesquisa ser abrangente
                clientesFiltrados = [];
                modoExibicaoArquivados = false;
                modoExibicaoOcultos = false;
                modoExibicaoVerDepois = false;
                modoExibicaoDesativados = false;
                filtroProduto = null; // NOVO: Limpa filtro de produto
            } else if (modoExibicaoArquivados) {
                clientesParaProcessar = clientes.filter(cliente => cliente.arquivado);
            } else if (modoExibicaoOcultos) {
                clientesParaProcessar = clientes.filter(cliente => cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado);
            } else if (modoExibicaoVerDepois) {
                clientesParaProcessar = clientes.filter(cliente => cliente.verDepois && !cliente.arquivado && !cliente.oculto && !cliente.desativado);
            } else if (modoExibicaoDesativados) {
                clientesParaProcessar = clientes.filter(cliente => cliente.desativado);
            } else if (filtroProduto) { // NOVO: Filtra por produto
                clientesParaProcessar = clientes.filter(cliente => cliente.Produto === filtroProduto && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            }
            else if (clientesFiltrados.length > 0) {
                clientesParaProcessar = clientesFiltrados.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            } else { // Exibi√ß√£o padr√£o: n√£o arquivados, n√£o ocultos, n√£o verDepois, n√£o desativados
                clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            }

            clientesExibidos = clientesParaProcessar;
            if (clientesExibidos.length === 0) {
                document.querySelector("table").style.display = "none";
                document.getElementById("tabelaClientes").innerHTML = `<tr><td colspan="1" style="text-align: center; color: gray;">Nenhum cliente para exibir neste filtro.</td></tr>`;
                atualizarContadores();
                return;
            }

            document.querySelector("table").style.display = "table";
            const tabela = document.getElementById("tabelaClientes");
            tabela.innerHTML = "";

            clientesExibidos.sort((a, b) => {
                const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));
                const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));
                const dataA = new Date(anoA, mesA - 1, diaA);
                const dataB = new Date(anoB, mesB - 1, diaB);
                return dataA - dataB;
            });

            const hoje = new Date();
            const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                hoje.getFullYear();

            clientesExibidos.forEach((cliente, index) => {
                const tr = document.createElement("tr");

                tr.classList.remove("avisado", "debito", "vencendo-hoje", "vencido");

                if (cliente.avisado) tr.classList.add("avisado");
                if (cliente.debito) tr.classList.add("debito");

                const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(ano, mes - 1, dia);

                if (cliente.data === hojeFormatada) {
                    tr.classList.add("vencendo-hoje");
                } else if (dataCliente < hoje && cliente.data !== hojeFormatada) {
                    tr.classList.add("vencido");
                }

                let botoesAcao = '';
                if (modoExibicaoArquivados) {
                    botoesAcao = `
                        <button title="Desarquivar Cliente" onclick="desarquivar(${index})">Desarquivar</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})">‚ùå</button>
                    `;
                } else if (modoExibicaoVerDepois) {
                    botoesAcao = `
                        <button title="Desmarcar Ver Depois" onclick="toggleVerDepois(${index})">Desmarcar</button>
                        <button title="Editar Cliente" onclick="editar(${index})">Edit</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})">‚ùå</button>
                    `;
                } else if (modoExibicaoDesativados) {
                    botoesAcao = `
                        <button title="Reativar Cliente" onclick="toggleDesativado(${index})">Reativar</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})">‚ùå</button>
                    `;
                } else {
                    // NOVO: Adiciona o bot√£o de alterar produto aqui
                    const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                    botoesAcao = `
                        <button title="Duplicar Cliente" onclick="duplicarCliente(${index})">+</button>
                        <button title="Renovar Autom√°tico" onclick="renovarAutomatico(${index})">üîÅ</button>
                        <button title="Renovar com D√©bito (Confirma√ß√£o)"
                                class="btn-debito-segurar"
                                onclick="pedirConfirmacaoRenovacaoDebito(${index})">D√âBITO</button>
                        <button title="Marcar/Desmarcar Ver Depois" onclick="toggleVerDepois(${index})">${cliente.verDepois ? "Desmarcar Ver Depois" : "Ver Depois"}</button>
                        <button title="Alterar Produto" onclick="abrirModalAlterarProduto(${index})">Produto</button> 
                        <button title="Editar Cliente" onclick="editar(${index})">Edit</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})">‚ùå</button>
                        <button title="Arquivar Cliente" onclick="arquivar(${index})">üìÇ</button>
                        <button title="Desativar Cliente" onclick="toggleDesativado(${index})">Desativar</button>
                    `;
                }

                // NOVO: Exibe o nome do cliente removendo a parte do produto, e adiciona o produto entre par√™nteses ao lado do link
                const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                tr.innerHTML = `
                    <td>
                        ${cliente.data}
                        <a href="#" onclick="enviarMensagemWhatsApp('${nomeExibicaoBase}', '${cliente.telefone}', ${index}); return false;">
                            ${nomeExibicaoBase} (${cliente.Produto || 'N/I'})
                        </a>
                        ${botoesAcao}
                    </td>
                `;
                tabela.appendChild(tr);
            });
            atualizarContadores();
        }

        function pedirConfirmacaoRenovacaoDebito(index) {
            clienteIndexParaRenovarDebito = index;
            document.getElementById("modalRenovarComDebito").style.display = "flex";
            document.getElementById("btnConfirmarRenovacaoDebito").onclick = () => confirmarRenovacaoComDebito();
            atualizarUltimaAtualizacao("confirmar renova√ß√£o com d√©bito");
        }

        function renovarAutomatico(index) {
            const cliente = clientesExibidos[index];
            const produtoCliente = cliente.Produto || "N√£o informado"; // NOVO: Obt√©m o produto do cliente

            if (produtoCliente === "N√£o informado") {
                exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                return;
            }

            salvarEstadoNoHistorico();
            let clienteOriginal = clientes.find(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginal) {
                // NOVO: L√≥gica de renova√ß√£o baseada no produto
                if (produtoCliente === "Duplecast") {
                    renovarProximoMes(clienteOriginal);
                } else if (produtoCliente === "UniTv") {
                    renovar30(clienteOriginal);
                } else {
                    exibirAlerta("Tipo de produto desconhecido para renova√ß√£o autom√°tica.");
                    return;
                }
                clienteOriginal.debito = false;
                clienteOriginal.oculto = false;
                clienteOriginal.verDepois = false;
                clienteOriginal.desativado = false;
            }
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("cliente renovado");
        }

        function confirmarRenovacaoComDebito() {
            if (clienteIndexParaRenovarDebito !== null) {
                salvarEstadoNoHistorico();
                const cliente = clientesExibidos[clienteIndexParaRenovarDebito];
                const produtoCliente = cliente.Produto || "N√£o informado"; // NOVO: Obt√©m o produto do cliente

                if (produtoCliente === "N√£o informado") {
                    exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                    fecharModal();
                    return;
                }

                let clienteOriginal = clientes.find(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
                if (clienteOriginal) {
                    // NOVO: L√≥gica de renova√ß√£o baseada no produto
                    if (produtoCliente === "Duplecast") {
                        renovarProximoMes(clienteOriginal);
                    } else if (produtoCliente === "UniTv") {
                        renovar30(clienteOriginal);
                    } else {
                        exibirAlerta("Tipo de produto desconhecido para renova√ß√£o autom√°tica.");
                        fecharModal();
                        return;
                    }
                    clienteOriginal.debito = true;
                    clienteOriginal.oculto = false;
                    clienteOriginal.verDepois = false;
                    clienteOriginal.desativado = false;
                }
                clientesFiltrados = [];
                modoExibicaoArquivados = false;
                modoExibicaoOcultos = false;
                modoExibicaoVerDepois = false;
                modoExibicaoDesativados = false;
                filtroProduto = null; // NOVO: Reseta o filtro de produto
                exibirTabela();
                salvarClientes();
                fecharModal();
                clienteIndexParaRenovarDebito = null;
                exibirAlerta("Cliente renovado e marcado como D√âBITO!");
                atualizarUltimaAtualizacao("cliente renovado com d√©bito");
            }
        }

        function renovar30(clienteObj) {
            clienteObj.data = incrementarData(clienteObj.data, 30);
        }

        function renovarProximoMes(clienteObj) {
            const [dia, mes, ano] = clienteObj.data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);

            dataObj.setMonth(dataObj.getMonth() + 1);

            if (dataObj.getDate() !== dia) {
                dataObj.setDate(0);
            }

            clienteObj.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
        }
        function incrementarData(data, dias) {
            const [dia, mes, ano] = data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);
            dataObj.setDate(dataObj.getDate() + dias);
            return `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
        }
        function duplicarCliente(index) {
            clienteIndexParaDuplicar = index;
            document.getElementById("modalConfirmacao").style.display = "flex";
            atualizarUltimaAtualizacao("confirmar duplica√ß√£o");
        }

        function confirmarDuplicacao() {
            if (clienteIndexParaDuplicar !== null) {
                salvarEstadoNoHistorico();
                const clienteOriginal = clientesExibidos[clienteIndexParaDuplicar];

                const novoCliente = {
                    data: clienteOriginal.data,
                    nome: clienteOriginal.nome,
                    telefone: clienteOriginal.telefone,
                    avisado: false,
                    debito: false,
                    Produto: clienteOriginal.Produto || "N√£o informado", // NOVO: Copia a propriedade Produto
                    arquivado: false,
                    oculto: false,
                    verDepois: false,
                    desativado: false
                };
                clientes.push(novoCliente);
                clientesFiltrados = [];
                modoExibicaoArquivados = false;
                modoExibicaoOcultos = false;
                modoExibicaoVerDepois = false;
                modoExibicaoDesativados = false;
                filtroProduto = null; // NOVO: Reseta o filtro de produto
                exibirTabela();
                salvarClientes();
                fecharModal();
                clienteIndexParaDuplicar = null;
                atualizarUltimaAtualizacao("cliente duplicado");
            }
        }

        function enviarMensagemWhatsApp(clienteNome, clienteTelefone, index) {
            const telefoneLimpo = clienteTelefone.replace(/\D/g, '');
            if (!telefoneLimpo) {
                exibirAlerta("N√∫mero de telefone inv√°lido!");
                return;
            }

            const cliente = clientesExibidos[index];
            const vencimento = cliente.data;
            const hoje = new Date();
            const [dia, mes, ano] = vencimento.split("/").map(num => parseInt(num));
            const dataVencimento = new Date(ano, mes - 1, dia);

            const hojeFormatado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const vencido = dataVencimento < hojeFormatado;

            const hora = hoje.getHours();
            let saudacao = "Ol√°";
            if (hora >= 6 && hora < 12) {
                saudacao = "Bom dia";
            } else if (hora >= 12 && hora < 18) {
                saudacao = "Boa tarde";
            } else {
                saudacao = "Boa noite";
            }

            // NOVO: Remove a informa√ß√£o do produto do nome ao criar a mensagem
            const nomeParaMensagem = clienteNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

            let mensagem;
            if (vencido) {
                mensagem = `${saudacao}! Seu plano de TV *est√° vencido* *${vencimento}*. Lembrando que pagando no dia do vencimento o mensal √© de 30 reais,ap√≥s o dia de vencimento o mensal √© de 35 reais.O pagamento via PIX pode ser feito no n√∫mero: *11950912509* (Waldemar Jose Luiz)`;
            } else {
                mensagem = `${saudacao}! Hoje √© o vencimento do seu plano de TV.*Vencimento*: ${cliente.data}O pagamento via PIX pode ser realizado no n√∫mero: *11950912509* (Waldemar Jose Luiz)`;
            }

            const url = `https://wa.me/${telefoneLimpo}?text=${encodeURIComponent(mensagem)}`;
            const link = document.createElement("a");
            link.href = url;
            link.target = "_blank";
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            setTimeout(() => {
                if (link.parentNode) {
                    link.parentNode.removeChild(link);
                }
            }, 100);

            let clienteOriginal = clientes.find(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginal) {
                clienteOriginal.oculto = true;
            }
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("mensagem WhatsApp enviada");
        }
        function exportarClientes() {
            // Antes de exportar, garanta que todos os clientes tenham as propriedades esperadas
            const clientesParaExportar = clientes.map(c => ({
                data: c.data,
                nome: c.nome,
                telefone: c.telefone,
                avisado: c.avisado || false,
                debito: c.debito || false,
                Produto: c.Produto || "N√£o informado", // NOVO: Garante que 'Produto' esteja no objeto
                arquivado: c.arquivado || false,
                oculto: c.oculto || false,
                verDepois: c.verDepois || false,
                desativado: c.desativado || false
            }));

            const clientesJson = JSON.stringify(clientesParaExportar, null, 4);
            const blob = new Blob([clientesJson], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "clientes.json";
            link.click();
            atualizarUltimaAtualizacao("clientes exportados");
        }

        function importarClientes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        salvarEstadoNoHistorico();
                        const clientesImportados = JSON.parse(reader.result);

                        // Mapeia os clientes importados para garantir que tenham todas as propriedades padr√£o
                        const clientesCorrigidos = clientesImportados.map(cliente => ({
                            data: cliente.data,
                            // Garante que o nome tenha o formato (Produto) ao importar (e remove se houver duplicidade)
                            nome: cliente.Produto && !cliente.nome.includes(`(${cliente.Produto})`) ?
                                `${cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')} (${cliente.Produto})` :
                                cliente.nome,
                            telefone: cliente.telefone,
                            avisado: cliente.avisado || false,
                            debito: cliente.debito || false,
                            Produto: cliente.Produto || "N√£o informado", // NOVO: Garante que 'Produto' exista
                            arquivado: cliente.arquivado || false,
                            oculto: cliente.oculto || false,
                            verDepois: cliente.verDepois || false,
                            desativado: cliente.desativado || false
                        }));

                        // Filtra para adicionar apenas clientes que n√£o existem na lista atual
                        const novosClientesUnicos = clientesCorrigidos.filter(novoCliente =>
                            !clientes.some(existente =>
                                existente.nome === novoCliente.nome &&
                                existente.data === novoCliente.data &&
                                existente.telefone === novoCliente.telefone &&
                                existente.Produto === novoCliente.Produto // NOVO: Considera o produto na unicidade
                            )
                        );

                        clientes = [...clientes, ...novosClientesUnicos];

                        // Ap√≥s a importa√ß√£o, redefina os filtros para exibir o estado padr√£o
                        clientesFiltrados = [];
                        modoExibicaoArquivados = false;
                        modoExibicaoOcultos = false;
                        modoExibicaoVerDepois = false;
                        modoExibicaoDesativados = false;
                        filtroProduto = null; // NOVO: Reseta o filtro de produto
                        document.getElementById("searchInput").value = "";

                        exibirTabela();
                        salvarClientes();
                        exibirAlerta(`Clientes importados com sucesso! Foram adicionados ${novosClientesUnicos.length} novos clientes.`);
                        atualizarUltimaAtualizacao("clientes importados");
                    } catch (error) {
                        exibirAlerta("Erro ao importar JSON. Verifique o arquivo.");
                        console.error("Erro ao importar:", error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function filtrarHoje() {
            const hoje = new Date();
            const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                hoje.getFullYear();

            clientesFiltrados = clientes.filter(cliente => cliente.data === hojeFormatada && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("filtrado por vencendo hoje");
        }

        function filtrarAmanha() {
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +
                (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +
                amanha.getFullYear();

            clientesFiltrados = clientes.filter(cliente => cliente.data === amanhaFormatada && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("filtrado por vencendo amanh√£");
        }

        function filtrarVencidos() {
            const hoje = new Date();
            clientesFiltrados = clientes.filter(cliente => {
                const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(ano, mes - 1, dia);
                const dataClienteSemHora = new Date(ano, mes - 1, dia);
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

                return dataClienteSemHora < hojeSemHora && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado;
            });
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("filtrado por vencidos");
        }

        function filtrarDebito() {
            clientesFiltrados = clientes.filter(cliente => cliente.debito && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Desativa filtro de produto
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("filtrado por d√©bito");
        }

        function exibirTodos() {
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            clientes.forEach(cliente => cliente.oculto = false); // <--- Isso "desoculta" todos.
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("exibindo todos os clientes");
        }

        function confirmarLimparTodos() {
            exibirConfirmacaoGenerica(
                "Limpar Todos os Clientes",
                "Tem certeza que deseja limpar **TODOS** os clientes? Essa a√ß√£o n√£o pode ser desfeita e os dados ser√£o perdidos permanentemente!",
                limparTodos,
                true
            );
        }

        function confirmarDesfazer() {
            if (historicoClientes.length <= 1) {
                exibirAlerta("N√£o h√° a√ß√µes para desfazer.");
                return;
            }

            const estadoPrevistoAposDesfazer = historicoClientes.length > 1 ?
                JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 2])) : [];

            if (estadoPrevistoAposDesfazer.length === 0) {
                exibirConfirmacaoGenerica(
                    "Desfazer √öltima A√ß√£o (CUIDADO!)",
                    "Aten√ß√£o: A pr√≥xima a√ß√£o de desfazer ir√° **LIMPAR TODA A SUA LISTA DE CLIENTES**! Tem certeza que deseja continuar?",
                    desfazer,
                    true
                );
            } else {
                exibirConfirmacaoGenerica(
                    "Desfazer √öltima A√ß√£o",
                    "Tem certeza que deseja desfazer a √∫ltima altera√ß√£o? Isso ir√° reverter a lista de clientes para o estado anterior.",
                    desfazer,
                    false
                );
            }
        }

        function confirmarRefazer() {
            if (redoHistory.length === 0) {
                exibirAlerta("N√£o h√° a√ß√µes para refazer.");
                return;
            }
            exibirConfirmacaoGenerica(
                "Refazer √öltima A√ß√£o",
                "Tem certeza que deseja refazer a √∫ltima a√ß√£o desfeita?",
                refazer,
                false
            );
        }

        function limparTodos() {
            salvarEstadoNoHistorico();
            clientes = [];
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            exibirTabela();
            salvarClientes();
            exibirAlerta("Todos os clientes foram limpos!");
            atualizarUltimaAtualizacao("lista limpa");
        }

        function desfazer() {
            if (historicoClientes.length <= 1) {
                exibirAlerta("N√£o h√° a√ß√µes para desfazer.");
                return;
            }

            redoHistory.push(JSON.parse(JSON.stringify(clientes)));

            historicoClientes.pop();
            clientes = JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 1]));

            salvarClientes();
            exibirTodos(); // Reexibe todos para garantir que o estado desfeito seja vis√≠vel
            exibirAlerta("√öltima a√ß√£o desfeita!");
            atualizarUltimaAtualizacao("√∫ltima a√ß√£o desfeita");
        }

        function refazer() {
            if (redoHistory.length === 0) {
                exibirAlerta("N√£o h√° a√ß√µes para refazer.");
                return;
            }

            salvarEstadoNoHistorico(false);
            clientes = redoHistory.pop();
            salvarClientes();
            exibirTodos(); // Reexibe todos para garantir que o estado refeito seja vis√≠vel
            exibirAlerta("√öltima a√ß√£o refeita!");
            atualizarUltimaAtualizacao("√∫ltima a√ß√£o refeita");
        }

        function editar(index) {
            let cliente = clientesExibidos[index];
            const modalEdicao = document.getElementById("modalEdicao");
            modalEdicao.style.display = "flex";

            // NOVO: Remove a parte do produto do nome para preencher o campo de edi√ß√£o
            const nomeLimpo = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');

            modalEdicao.innerHTML = `
                <div class="modal-content">
                    <h3>Editar Cliente</h3>
                    <input type="text" id="novoNome" value="${nomeLimpo}" placeholder="Nome"><br><br>
                    <input type="tel" id="novoTelefone" value="${cliente.telefone}" placeholder="Telefone"><br><br>
                    <input type="date" id="novaData" value="${formatarParaInputDate(cliente.data)}"><br><br>

                    <div>
                        <label>
                            <input type="radio" name="editarProduto" value="UniTv" ${cliente.Produto === "UniTv" ? "checked" : ""}> UniTv
                        </label>
                        <label>
                            <input type="radio" name="editarProduto" value="Duplecast" ${cliente.Produto === "Duplecast" ? "checked" : ""}> Duplecast
                        </label>
                    </div>
                    <br>
                    <button id="salvarBtn">Salvar</button>
                    <button onclick="fecharModal()">Cancelar</button>
                </div>
            `;
            document.getElementById("novoNome").focus();
            document.getElementById("novoNome").addEventListener("keydown", (e) => proximoCampo(e, "novoTelefone"));
            document.getElementById("novoTelefone").addEventListener("keydown", (e) => proximoCampo(e, "novaData"));
            document.getElementById("novaData").addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    document.getElementById("salvarBtn").focus();
                }
            });
            document.getElementById("salvarBtn").addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    salvarEdicao(index);
                }
            });
            document.getElementById("salvarBtn").addEventListener("click", () => salvarEdicao(index));
            document.addEventListener("keydown", fecharComEsc);
            atualizarUltimaAtualizacao("in√≠cio da edi√ß√£o");
        }

        function proximoCampo(event, proximoId) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById(proximoId)?.focus();
            }
        }

        function salvarEdicao(index) {
            salvarEstadoNoHistorico();
            const clienteParaAtualizar = clientesExibidos[index];
            let clienteOriginalIndex = clientes.findIndex(c => c.nome === clienteParaAtualizar.nome && c.data === clienteParaAtualizar.data && c.telefone === clienteParaAtualizar.telefone);

            if (clienteOriginalIndex === -1) {
                exibirAlerta("Cliente n√£o encontrado na lista principal!");
                fecharModal();
                return;
            }

            let novoNome = document.getElementById("novoNome").value.trim();
            let novoTelefone = document.getElementById("novoTelefone").value.trim();
            let novaData = document.getElementById("novaData").value.trim();
            let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value; // NOVO: Captura o produto editado

            if (!novoNome || !novaData) {
                exibirAlerta("Nome e data s√£o obrigat√≥rios!");
                return;
            }

            // NOVO: Ajusta o nome para incluir o produto
            let nomeSemProduto = novoNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
            let nomeComNovoProduto = `${nomeSemProduto} (${novoProduto})`;

            clientes[clienteOriginalIndex].nome = nomeComNovoProduto; // NOVO: Atualiza o nome com o produto
            clientes[clienteOriginalIndex].telefone = novoTelefone;
            clientes[clienteOriginalIndex].data = novaData.split("-").reverse().join("/");
            clientes[clienteOriginalIndex].Produto = novoProduto; // NOVO: Atualiza a propriedade Produto

            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            clientes.forEach(cliente => cliente.oculto = false); // Reexibe ocultos ao editar
            document.getElementById("searchInput").value = "";

            exibirTabela();
            salvarClientes();
            fecharModal();
            atualizarUltimaAtualizacao("cliente editado");
        }

        function formatarParaInputDate(data) {
            let [dia, mes, ano] = data.split("/");
            return `${ano}-${mes}-${dia}`;
        }

        function excluir(index) {
            const cliente = clientesExibidos[index];
            clienteIndexParaExcluir = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteIndexParaExcluir !== -1) {
                document.getElementById("modalExclusao").style.display = "flex";
            }
            atualizarUltimaAtualizacao("confirmar exclus√£o");
        }

        function confirmarExclusao() {
            if (clienteIndexParaExcluir !== null) {
                salvarEstadoNoHistorico();
                clientes.splice(clienteIndexParaExcluir, 1);

                clientesFiltrados = [];
                modoExibicaoArquivados = false;
                modoExibicaoOcultos = false;
                modoExibicaoVerDepois = false;
                modoExibicaoDesativados = false;
                filtroProduto = null; // NOVO: Reseta o filtro de produto
                clientes.forEach(cliente => cliente.oculto = false);
                document.getElementById("searchInput").value = "";

                exibirTabela();
                salvarClientes();
                fecharModal();
                clienteIndexParaExcluir = null;
                atualizarUltimaAtualizacao("cliente exclu√≠do");
            }
        }

        function toggleAvisado(index) {
            salvarEstadoNoHistorico();
            let cliente = clientesExibidos[index];
            let clienteOriginalIndex = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginalIndex !== -1) {
                clientes[clienteOriginalIndex].avisado = !clientes[clienteOriginalIndex].avisado;
                clientes[clienteOriginalIndex].oculto = false; // Ao marcar/desmarcar avisado, ele n√£o estar√° oculto
            }
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("status de avisado alterado");
        }

        function toggleDebito(index) {
            salvarEstadoNoHistorico();
            let cliente = clientesExibidos[index];
            let clienteOriginalIndex = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginalIndex !== -1) {
                clientes[clienteOriginalIndex].debito = !clientes[clienteOriginalIndex].debito;
            }
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("status de d√©bito alterado");
        }

        function toggleVerDepois(index) {
            salvarEstadoNoHistorico();
            let cliente = clientesExibidos[index];
            let clienteOriginalIndex = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginalIndex !== -1) {
                clientes[clienteOriginalIndex].verDepois = !clientes[clienteOriginalIndex].verDepois;
                if (clientes[clienteOriginalIndex].verDepois) { // Se marcou "Ver Depois", oculta dos outros filtros
                    clientes[clienteOriginalIndex].oculto = false;
                    clientes[clienteOriginalIndex].arquivado = false;
                    clientes[clienteOriginalIndex].desativado = false;
                }
            }
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("status de ver depois alterado");
        }

        function toggleDesativado(index) {
            salvarEstadoNoHistorico();
            let cliente = clientesExibidos[index];
            let clienteOriginalIndex = clientes.findIndex(c => c.nome === cliente.nome && c.data === cliente.data && c.telefone === cliente.telefone);
            if (clienteOriginalIndex !== -1) {
                clientes[clienteOriginalIndex].desativado = !clientes[clienteOriginalIndex].desativado;
                if (clientes[clienteOriginalIndex].desativado) { // Se desativado, remove de outros status para n√£o aparecer em listas ativas
                    clientes[clienteOriginalIndex].avisado = false;
                    clientes[clienteOriginalIndex].debito = false;
                    clientes[clienteOriginalIndex].oculto = false;
                    clientes[clienteOriginalIndex].verDepois = false;
                    clientes[clienteOriginalIndex].arquivado = false;
                }
            }
            exibirTabela();
            salvarClientes();
            atualizarUltimaAtualizacao("status de desativado alterado");
        }

        // NOVO: Fun√ß√£o para abrir o modal de escolha de produto
        function abrirModalAlterarProduto(index) {
            clienteIndexParaAlterarProduto = index;
            document.getElementById('modalEscolherProduto').style.display = 'flex';
            atualizarUltimaAtualizacao("escolhendo produto para altera√ß√£o");
        }

        // NOVO: Fun√ß√£o para confirmar a altera√ß√£o do produto do cliente
        function alterarProdutoClienteConfirm(novoProduto) {
            if (clienteIndexParaAlterarProduto !== null) {
                salvarEstadoNoHistorico();
                const clienteParaAtualizar = clientesExibidos[clienteIndexParaAlterarProduto];
                let clienteOriginalIndex = clientes.findIndex(c => c.nome === clienteParaAtualizar.nome && c.data === clienteParaAtualizar.data && c.telefone === clienteParaAtualizar.telefone);

                if (clienteOriginalIndex !== -1) {
                    let nomeSemProduto = clientes[clienteOriginalIndex].nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                    clientes[clienteOriginalIndex].Produto = novoProduto;
                    clientes[clienteOriginalIndex].nome = `${nomeSemProduto} (${novoProduto})`;
                }
                // Ap√≥s a altera√ß√£o de produto, redefina os filtros para exibir o estado padr√£o
                clientesFiltrados = [];
                modoExibicaoArquivados = false;
                modoExibicaoOcultos = false;
                modoExibicaoVerDepois = false;
                modoExibicaoDesativados = false;
                filtroProduto = null;
                exibirTabela();
                salvarClientes();
                fecharModal();
                clienteIndexParaAlterarProduto = null;
                exibirAlerta(`Produto do cliente alterado para ${novoProduto}!`);
                atualizarUltimaAtualizacao(`produto do cliente alterado para ${novoProduto}`);
            }
        }

        function salvarClientes() {
            localStorage.setItem('clientes', JSON.stringify(clientes));
        }

        function loadClientes() {
            try {
                const storedClientes = localStorage.getItem('clientes');
                if (storedClientes) {
                    const parsedClientes = JSON.parse(storedClientes);
                    // Garante que cada cliente carregado do localStorage tenha todas as propriedades
                    clientes = parsedClientes.map(c => ({
                        data: c.data,
                        nome: c.nome,
                        telefone: c.telefone,
                        avisado: c.avisado || false,
                        debito: c.debito || false,
                        Produto: c.Produto || "N√£o informado", // NOVO: Garante que 'Produto' exista
                        arquivado: c.arquivado || false,
                        oculto: c.oculto || false,
                        verDepois: c.verDepois || false,
                        desativado: c.desativado || false
                    }));
                } else {
                    clientes = [];
                }
            } catch (e) {
                console.error("Erro ao carregar clientes do localStorage:", e);
                clientes = []; // Reseta clientes em caso de erro no localStorage
                localStorage.removeItem('clientes'); // Limpa dados corrompidos
            }
            atualizarUltimaAtualizacao("clientes carregados");
        }

        function compartilharWhatsApp() {
            const url = `https://wa.me/?text=${encodeURIComponent('Ol√°, estou compartilhando esta lista de clientes com voc√™.')}`;
            window.open(url, '_blank');
            atualizarUltimaAtualizacao("compartilhado via WhatsApp");
        }

        function pesquisarClientes() {
            const termoPesquisa = document.getElementById("searchInput").value.trim().toLowerCase();

            // Ao pesquisar, zera os outros modos de filtro para a pesquisa ser abrangente
            clientesFiltrados = [];
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto

            exibirTabela(); // exibirTabela j√° lida com o termoPesquisa
            atualizarUltimaAtualizacao("pesquisa realizada");
        }

        function limparPesquisa() {
            document.getElementById("searchInput").value = "";
            exibirTodos(); // Volta para a exibi√ß√£o padr√£o
            atualizarUltimaAtualizacao("pesquisa limpa");
        }

        // --- FUN√á√ïES DE AJUSTES ---
        const SETTINGS_KEY = 'inputSettings';
        const DEFAULT_INPUT_WIDTH_PERCENT = 16;

        function toggleSettingsArea() {
            const settingsArea = document.getElementById('settingsArea');
            if (settingsArea.style.display === 'block') {
                settingsArea.style.display = 'none';
            } else {
                settingsArea.style.display = 'block';
                loadSettings();
            }
            atualizarUltimaAtualizacao("ajustes acessados");
        }

        function applyInputWidth(widthPercent) {
            const inputs = document.querySelectorAll('.configurable-input');
            inputs.forEach(input => {
                input.style.flexBasis = `${widthPercent}%`;
                input.style.maxWidth = `${widthPercent}%`;
                input.style.width = 'auto';
            });
        }

        function updateInputWidth(value) {
            const widthValueSpan = document.getElementById('inputWidthValue');
            widthValueSpan.textContent = `${value}%`;
            applyInputWidth(value);
        }

        function saveSettings() {
            const inputWidth = document.getElementById('inputWidth').value;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({
                width: inputWidth
            }));
            exibirAlerta("Ajustes salvos com sucesso!");
            toggleSettingsArea();
            atualizarUltimaAtualizacao("ajustes salvos");
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            let widthToApply = DEFAULT_INPUT_WIDTH_PERCENT;

            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    widthToApply = settings.width || DEFAULT_INPUT_WIDTH_PERCENT;
                } catch (e) {
                    console.error("Erro ao carregar ajustes do localStorage:", e);
                    localStorage.removeItem(SETTINGS_KEY);
                }
            }

            const inputWidthElement = document.getElementById('inputWidth');
            if (inputWidthElement) {
                inputWidthElement.value = widthToApply;
            }
            const inputWidthValueSpan = document.getElementById('inputWidthValue');
            if (inputWidthValueSpan) {
                inputWidthValueSpan.textContent = `${widthToApply}%`;
            }
            applyInputWidth(widthToApply);
        }

        function resetSettings() {
            localStorage.removeItem(SETTINGS_KEY);
            exibirAlerta("Ajustes redefinidos para o padr√£o!");
            loadSettings();
            toggleSettingsArea();
            atualizarUltimaAtualizacao("ajustes redefinidos");
        }
        // --- FIM: FUN√á√ïES DE AJUSTES ---

        // --- Fun√ß√µes de Contadores ---
        function atualizarContadores() {
            const hoje = new Date();
            const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                hoje.getFullYear();

            // Conta apenas clientes que n√£o est√£o arquivados, ocultos, verDepois ou desativados para os filtros principais
            const clientesVisiveisParaFiltros = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);

            const countHoje = clientesVisiveisParaFiltros.filter(cliente => cliente.data === hojeFormatada).length;
            const countAmanha = clientesVisiveisParaFiltros.filter(cliente => {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +
                    (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +
                    amanha.getFullYear();
                return cliente.data === amanhaFormatada;
            }).length;
            const countVencidos = clientesVisiveisParaFiltros.filter(cliente => {
                const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(ano, mes - 1, dia);
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

                return dataCliente < hojeSemHora;
            }).length;
            const countDebito = clientesVisiveisParaFiltros.filter(cliente => cliente.debito).length;

            // Contadores para os filtros de "estado" (que n√£o excluem uns aos outros, apenas filtram por si mesmos)
            const countOcultos = clientes.filter(cliente => cliente.oculto && !cliente.arquivado && !cliente.verDepois && !cliente.desativado).length;
            const countArquivados = clientes.filter(cliente => cliente.arquivado).length;
            const countVerDepois = clientes.filter(cliente => cliente.verDepois).length;
            const countDesativados = clientes.filter(cliente => cliente.desativado).length;

            updateBadge('badgeHoje', countHoje);
            updateBadge('badgeAmanha', countAmanha);
            updateBadge('badgeVencidos', countVencidos);
            updateBadge('badgeDebito', countDebito);
            updateBadge('badgeOcultos', countOcultos);
            updateBadge('badgeArquivados', countArquivados);
            updateBadge('badgeVerDepois', countVerDepois);
            updateBadge('badgeDesativados', countDesativados);
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        // --- FIM: Fun√ß√µes de Contadores ---

        // NOVO: Fun√ß√£o para mostrar a contagem de produtos (vinda do primeiro c√≥digo)
        function mostrarContagemProdutos() {
            // Conta apenas clientes que n√£o est√£o arquivados, ocultos, verDepois ou desativados para os contadores de produto
            const clientesNaoArquivadosNaoOcultos = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado);
            const countUniTv = clientesNaoArquivadosNaoOcultos.filter(cliente => cliente.Produto === 'UniTv').length;
            const countDuplecast = clientesNaoArquivadosNaoOcultos.filter(cliente => cliente.Produto === 'Duplecast').length;

            document.getElementById('countUniTv').textContent = countUniTv;
            document.getElementById('countDuplecast').textContent = countDuplecast;

            document.getElementById('modalContagemProdutos').style.display = 'flex';
            atualizarUltimaAtualizacao("contagem de produtos exibida");
        }

        function inicializarExibicaoClientes() {
            // Carrega os clientes do localStorage primeiro
            loadClientes();

            // Preenche o campo de data com a data atual (YYYY-MM-DD)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa do 0, ent√£o +1
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('dataInput').value = `${year}-${month}-${day}`;

            // Ao inicializar, mostra os clientes vencendo hoje ou vencidos que N√ÉO est√£o arquivados, ocultos, verDepois ou desativados
            const hoje = new Date();
            const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                hoje.getFullYear();

            clientesFiltrados = clientes.filter(cliente => {
                const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(ano, mes - 1, dia);

                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());

                const isVencendoHoje = cliente.data === hojeFormatada;
                const isVencido = dataCliente < hojeSemHora;

                return (isVencendoHoje || isVencido) && !cliente.arquivado && !cliente.oculto && !cliente.verDepois && !cliente.desativado;
            });
            modoExibicaoArquivados = false;
            modoExibicaoOcultos = false;
            modoExibicaoVerDepois = false;
            modoExibicaoDesativados = false;
            filtroProduto = null; // NOVO: Reseta o filtro de produto
            document.getElementById("searchInput").value = "";

            exibirTabela(); // Exibe a tabela com o filtro padr√£o
            atualizarUltimaAtualizacao("inicializa√ß√£o da p√°gina");
        }

        // Inicializa√ß√£o
        document.getElementById('dataAtual').innerText = new Date().toLocaleDateString('pt-BR');
        inicializarExibicaoClientes(); // Chama a nova fun√ß√£o de inicializa√ß√£o
        salvarEstadoNoHistorico(); // Salva o estado inicial no hist√≥rico (ap√≥s carregar os dados)
        loadSettings(); // Carrega as configura√ß√µes de interface
    </script>
</body>
</html>
